<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kgosi BioDrone — Advanced Poultry Health System</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
      :root{
        --bg-primary: #f8f7ff;
        --bg-secondary: #ffffff;
        --text-primary: #2d1b69;
        --text-secondary: #6b46c1;
        --accent: #8b5cf6;
        --accent-hover: #7c3aed;
        --accent-light: #a78bfa;
        --border: #e9d5ff;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --purple-50: #faf5ff;
        --purple-100: #f3e8ff;
        --purple-200: #e9d5ff;
        --purple-300: #d8b4fe;
        --purple-500: #8b5cf6;
        --purple-600: #7c3aed;
        --purple-700: #6d28d9;
        --purple-900: #4c1d95;
        --radius: 12px;
        --shadow: 0 2px 8px rgba(139, 92, 246, 0.08);
        --shadow-lg: 0 8px 24px rgba(139, 92, 246, 0.12);
      }

      * { 
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
      }

      /* App Layout */
      .app {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      /* Header */
      .header {
        background: var(--bg-secondary);
        border-radius: var(--radius);
        padding: 20px 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .logo {
        width: 56px;
        height: 56px;
        background: rgba(255, 255, 255, 0.991);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      .brand-text h1 {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
      }

      .brand-text p {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
      }

      .status-indicators {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-online { background: var(--success); }
      .status-warning { background: var(--warning); }
      .status-offline { background: var(--danger); }

      /* Main Grid */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 24px;
      }

      /* Panels */
      .panel {
        background: var(--bg-secondary);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow);
      }

      .preview-area {
        height: 500px;
        border: 2px dashed var(--border);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        overflow: hidden;
        position: relative;
        margin: 20px 0;
      }

      .preview-area img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 6px;
      }
      
      .preview-area.expanded {
        height: 600px;
      }
      
      .image-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
      .preview-area:hover .image-controls {
        opacity: 1;
      }
      
      .image-control-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(0,0,0,0.7);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      .image-control-btn:hover {
        background: rgba(0,0,0,0.9);
        transform: scale(1.1);
      }

      .camera-feed {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
        border-radius: 8px;
        display: none;
      }

      .camera-feed video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }

      .camera-overlay {
        position: absolute;
        top: 16px;
        left: 16px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .camera-controls {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
      }

      .camera-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,0.9);
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.2s ease;
      }

      .camera-btn:hover {
        background: white;
        transform: scale(1.05);
      }

      /* Input Toggle */
      .input-toggle {
        display: flex;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 16px;
      }

      .toggle-option {
        flex: 1;
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .toggle-option.active {
        background: white;
        box-shadow: 0 1px 3px rgba(139, 92, 246, 0.2);
        color: var(--purple-600);
        border: 1px solid var(--purple-200);
      }

      /* Control Steps */
      .step {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
      }

      .step-number {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--purple-100), var(--purple-200));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--purple-700);
        flex-shrink: 0;
        border: 2px solid var(--purple-300);
      }

      .step-content {
        flex: 1;
      }

      .step-content h4 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .step-content p {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
      }

      /* Uploader */
      .uploader {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 20px;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .uploader:hover {
        border-color: var(--purple-300);
        background: var(--purple-50);
      }

      .uploader.dragover {
        border-color: var(--purple-500);
        background: var(--purple-100);
      }

      /* Results */
      .result-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 8px;
        background: var(--purple-100);
        color: var(--purple-700);
        font-weight: 600;
        font-size: 14px;
        border: 1px solid var(--purple-200);
      }

      .confidence-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--purple-400), var(--purple-500));
        transition: width 0.5s ease;
        border-radius: 4px;
      }

      /* Next Steps Panel */
      .next-steps {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
      }

      .next-steps h5 {
        color: var(--accent);
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .step-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
        padding: 8px;
        background: white;
        border-radius: 6px;
        font-size: 13px;
      }

      .step-item:last-child {
        margin-bottom: 0;
      }

      .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        font-size: 10px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 2px;
      }

      /* History Enhancement */
      .history-item {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .history-item:hover {
        background: var(--purple-50);
        border-color: var(--purple-300);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .severity-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .severity-healthy { background: #dcfce7; color: #166534; }
      .severity-warning { background: #fef3c7; color: #92400e; }
      .severity-critical { background: #fee2e2; color: #991b1b; }

      .severity-healthy { background: #dcfce7; color: #166534; }
      .severity-warning { background: #fef3c7; color: #92400e; }
      .severity-critical { background: #fee2e2; color: #991b1b; }

      /* Modals */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        padding: 40px;
        overflow-y: auto;
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-container {
        background: var(--bg-secondary);
        border-radius: 16px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        padding: 24px 32px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-content {
        padding: 24px 32px;
        overflow-y: auto;
        max-height: 70vh;
      }

      .care-section {
        margin-bottom: 24px;
      }

      .care-section h4 {
        color: var(--accent);
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .care-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }

      .care-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
      }

      .care-card h6 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
      }

      .care-card p {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
      }

      .timeline {
        position: relative;
        padding-left: 24px;
      }

      .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
      }

      .timeline-item {
        position: relative;
        margin-bottom: 16px;
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid var(--border);
      }

      .timeline-item::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        border: 3px solid white;
        box-shadow: 0 0 0 1px var(--border);
      }

      .settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        padding: 40px;
        overflow-y: auto;
      }

      .settings-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .settings-container {
        background: var(--bg-secondary);
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
      }

      .settings-sidebar {
        width: 280px;
        background: #f9fafb;
        border-right: 1px solid var(--border);
        padding: 24px 0;
      }

      .settings-sidebar-header {
        padding: 0 24px 16px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 8px;
      }

      .settings-sidebar h2 {
        font-size: 18px;
        font-weight: 600;
      }

      .settings-nav {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 24px;
        cursor: pointer;
        transition: background 0.2s ease;
        color: var(--text-primary);
        text-decoration: none;
      }

      .settings-nav-item:hover {
        background: #f3f4f6;
      }

      .settings-nav-item.active {
        background: #e5e7eb;
        font-weight: 500;
      }

      .settings-nav-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
        color: var(--text-secondary);
      }

      .settings-content {
        flex: 1;
        padding: 24px 32px;
        overflow-y: auto;
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .settings-header h3 {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
      }

      .settings-section {
        margin-bottom: 32px;
      }

      .settings-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
      }

      .setting-item:last-child {
        border-bottom: none;
      }

      .setting-label {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .setting-label span {
        font-size: 14px;
        font-weight: 500;
      }

      .setting-label small {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Form Controls */
      .switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: .3s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--purple-500);
      }

      input:checked + .slider:before {
        transform: translateX(24px);
      }

      .form-input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        width: 200px;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--purple-500);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25);
      }

      /* Auth Modal Styles */
      .auth-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(14, 165, 164, 0.1), rgba(6, 182, 212, 0.1));
        backdrop-filter: blur(10px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .auth-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        width: 100%;
        max-width: 420px;
        animation: slideUp 0.4s ease;
      }

      .auth-brand {
        background: linear-gradient(135deg, var(--purple-500), var(--purple-600));
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .auth-logo {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.991);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
        margin: 0 auto 16px;
        backdrop-filter: blur(10px);
      }

      .auth-brand h2 {
        font-size: 22px;
        font-weight: 700;
        margin: 0 0 8px;
      }

      .auth-brand p {
        font-size: 14px;
        opacity: 0.9;
        margin: 0;
      }

      .auth-form-container {
        padding: 30px;
      }

      .auth-tabs {
        display: flex;
        background: #f8fafc;
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 30px;
      }

      .auth-tab {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #64748b;
      }

      .auth-tab.active {
        background: white;
        color: var(--purple-600);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
      }

      .auth-form {
        animation: fadeIn 0.3s ease;
      }

      .auth-input-group {
        position: relative;
        margin-bottom: 20px;
      }

      .auth-input-group i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 16px;
        z-index: 1;
      }

      .auth-input-group input {
        width: 100%;
        padding: 16px 16px 16px 48px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: #fafbfc;
        transition: all 0.2s ease;
        box-sizing: border-box;
      }

      .auth-input-group input:focus {
        outline: none;
        border-color: var(--purple-500);
        background: white;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .auth-input-group input:focus + i {
        color: var(--purple-500);
      }

      .auth-btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
      }

      .auth-btn.primary {
        background: linear-gradient(135deg, var(--purple-500), var(--purple-600));
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      .auth-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
      }

      .auth-btn.primary:active {
        transform: translateY(0);
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .form-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        width: 200px;
        background: white;
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--purple-500);
        color: white;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
      }

      .btn-primary:hover {
        background: var(--purple-600);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: var(--purple-50);
        color: var(--purple-600);
        border: 1px solid var(--purple-200);
      }

      .btn-secondary:hover {
        background: var(--purple-100);
        border-color: var(--purple-300);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-warning {
        background: var(--warning);
        color: white;
      }

      /* Error Modal */
      .error-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-lg);
        z-index: 1060;
        max-width: 400px;
        width: 90%;
      }

      .error-modal.show {
        display: block;
      }

      .error-modal h3 {
        color: var(--danger);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .error-modal p {
        color: var(--text-secondary);
        margin-bottom: 20px;
      }

      /* Loading States */
      .loading {
        position: relative;
        overflow: hidden;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      /* Progress Modal Styles */
      .progress-spinner {
        margin: 0 auto 24px;
        width: 60px;
        height: 60px;
      }

      .spinner {
        width: 100%;
        height: 100%;
        border: 4px solid #f3f4f6;
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #f3f4f6;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--purple-500), var(--purple-600));
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      /* Enhanced Button States */
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .btn.loading {
        position: relative;
        color: transparent;
      }

      .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        border: 2px solid currentColor;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Enhanced Navbar */
      .navbar-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255,255,255,0.1);
        font-size: 11px;
        color: var(--text-secondary);
      }

      .connection-strength {
        display: flex;
        gap: 2px;
        align-items: flex-end;
      }

      .signal-bar {
        width: 3px;
        background: var(--success);
        border-radius: 1px;
      }

      .signal-bar:nth-child(1) { height: 4px; }
      .signal-bar:nth-child(2) { height: 6px; }
      .signal-bar:nth-child(3) { height: 8px; }
      .signal-bar:nth-child(4) { height: 10px; opacity: 0.3; }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .app {
          padding: 16px;
        }
        
        .main-grid {
          gap: 16px;
        }
      }

      @media (max-width: 968px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
        
        .header {
          flex-direction: column;
          gap: 16px;
          text-align: center;
        }
        
        .brand {
          flex-direction: column;
          gap: 12px;
        }
        
        .navbar-actions {
          flex-wrap: wrap;
          gap: 8px;
          justify-content: center;
        }
        
        .status-indicators {
          display: none;
        }
        
        .settings-container {
          flex-direction: column;
          max-height: 100vh;
        }
        
        .settings-sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }

        .care-grid {
          grid-template-columns: 1fr;
        }
        
        .preview-area {
          height: 300px;
        }
        
        .step {
          flex-direction: column;
          gap: 12px;
        }
        
        .step-number {
          align-self: flex-start;
        }
      }

      @media (max-width: 768px) {
        .app {
          padding: 12px;
        }
        
        .header {
          padding: 16px;
          margin-bottom: 16px;
        }
        
        .panel {
          padding: 16px;
        }
        
        .logo {
          width: 48px;
          height: 48px;
        }
        
        .brand-text h1 {
          font-size: 18px;
        }
        
        .brand-text p {
          font-size: 12px;
        }
        
        .preview-area {
          height: 350px;
          margin: 16px 0;
        }
        
        .preview-area.expanded {
          height: 450px;
        }
        
        .camera-controls {
          gap: 8px;
        }
        
        .camera-btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }
        
        .btn {
          padding: 8px 16px;
          font-size: 13px;
        }
        
        .step-number {
          width: 40px;
          height: 40px;
        }
        
        .step-content h4 {
          font-size: 14px;
        }
        
        .step-content p {
          font-size: 12px;
        }
        
        .modal-container {
          margin: 20px;
          max-width: calc(100vw - 40px);
        }
        
        .auth-container {
          margin: 20px;
          max-width: calc(100vw - 40px);
        }
        
        .auth-form-container {
          padding: 20px;
        }
        
        .auth-brand {
          padding: 30px 20px;
        }
      }

      @media (max-width: 480px) {
        .app {
          padding: 8px;
        }
        
        .header {
          padding: 12px;
          margin-bottom: 12px;
        }
        
        .panel {
          padding: 12px;
        }
        
        .brand {
          gap: 8px;
        }
        
        .logo {
          width: 40px;
          height: 40px;
        }
        
        .brand-text h1 {
          font-size: 16px;
        }
        
        .brand-text p {
          display: none;
        }
        
        .navbar-actions {
          gap: 4px;
        }
        
        .btn {
          padding: 6px 12px;
          font-size: 12px;
        }
        
        .preview-area {
          height: 280px;
          margin: 12px 0;
        }
        
        .preview-area.expanded {
          height: 350px;
        }
        
        .input-toggle {
          flex-direction: column;
          gap: 4px;
        }
        
        .toggle-option {
          padding: 10px;
          border-radius: 6px;
        }
        
        .step {
          gap: 8px;
        }
        
        .step-number {
          width: 32px;
          height: 32px;
          font-size: 14px;
        }
        
        .step-content h4 {
          font-size: 13px;
        }
        
        .step-content p {
          font-size: 11px;
        }
        
        .uploader {
          padding: 16px;
        }
        
        .camera-controls {
          gap: 6px;
          bottom: 12px;
        }
        
        .camera-btn {
          width: 36px;
          height: 36px;
          font-size: 14px;
        }
        
        .modal-container,
        .auth-container {
          margin: 10px;
          max-width: calc(100vw - 20px);
          max-height: calc(100vh - 20px);
        }
        
        .auth-form-container {
          padding: 16px;
        }
        
        .auth-brand {
          padding: 20px 16px;
        }
        
        .auth-logo {
          width: 48px;
          height: 48px;
        }
        
        .auth-brand h2 {
          font-size: 18px;
        }
        
        .auth-brand p {
          font-size: 12px;
        }
        
        .history-item {
          padding: 8px;
        }
        
        .result-badge {
          padding: 6px 12px;
          font-size: 12px;
        }
      }

      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        .btn,
        .camera-btn,
        .toggle-option {
          min-height: 44px;
        }
        
        .history-item {
          min-height: 44px;
          display: flex;
          align-items: center;
        }
      }

      /* Landscape phone adjustments */
      @media (max-width: 768px) and (orientation: landscape) {
        .preview-area {
          height: 180px;
        }
        
        .header {
          flex-direction: row;
          padding: 12px 16px;
        }
        
        .brand {
          flex-direction: row;
          gap: 12px;
        }
        
        .brand-text p {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal" style="display: flex;">
      <div class="auth-container">
        <div class="auth-brand">
          <div class="auth-logo">
            <img src="{{ url_for('static', filename='applogo.png') }}" alt="Kgosi Logo" style="width: 100%; height: 100%; object-fit: contain;">
          </div>
          <h2>Kgosi BioDrone</h2>
          <p>Advanced AI-powered poultry health monitoring</p>
        </div>
        
        <div class="auth-form-container">
          <div class="auth-tabs">
            <button class="auth-tab active" onclick="showLogin()" id="loginTab">Sign In</button>
            <button class="auth-tab" onclick="showRegister()" id="registerTab">Sign Up</button>
          </div>
          
          <div id="loginForm" class="auth-form">
            <div class="auth-input-group">
              <i class="bi bi-person"></i>
              <input type="text" id="loginUsername" placeholder="Username" required>
            </div>
            <div class="auth-input-group">
              <i class="bi bi-lock"></i>
              <input type="password" id="loginPassword" placeholder="Password" required>
            </div>
            <button class="auth-btn primary" onclick="login()">
              <span>Sign In</span>
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
          
          <div id="registerForm" class="auth-form" style="display: none;">
            <div class="auth-input-group">
              <i class="bi bi-person-plus"></i>
              <input type="text" id="regUsername" placeholder="Username" required>
            </div>
            <div class="auth-input-group">
              <i class="bi bi-envelope"></i>
              <input type="email" id="regEmail" placeholder="Email" required>
            </div>
            <div class="auth-input-group">
              <i class="bi bi-lock"></i>
              <input type="password" id="regPassword" placeholder="Password" required>
            </div>
            <div class="auth-input-group">
              <i class="bi bi-shield-check"></i>
              <input type="password" id="regConfirmPassword" placeholder="Confirm Password" required>
            </div>
            <button class="auth-btn primary" onclick="register()">
              <span>Create Account</span>
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="app">
      <!-- Header -->
      <header class="header">
        <div class="brand">
          <div class="logo">
            <img src="{{ url_for('static', filename='applogo.png') }}" alt="Kgosi Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
          </div>
          <div class="brand-text">
            <h1>Kgosi BioDrone</h1>
            <p>Advanced AI-powered poultry health monitoring system</p>
          </div>
        </div>
        
        <div class="navbar-actions">
          <span id="userWelcome" style="margin-right: 15px; color: #666;"></span>
          <div class="status-indicators">
            <div class="status-indicator">
              <span>Drone:</span>
              <span class="status-dot status-online" title="Drone Online"></span>
            </div>
            <div class="status-indicator">
              <span>AI:</span>
              <span class="status-dot status-online" title="AI Ready"></span>
            </div>
            <div class="status-indicator">
              <span>Signal:</span>
              <div class="connection-strength">
                <div class="signal-bar"></div>
                <div class="signal-bar"></div>
                <div class="signal-bar"></div>
                <div class="signal-bar"></div>
              </div>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="showEnvironmentalData()" title="Environmental Data">
            <i class="bi bi-thermometer-half"></i>
          </button>
          <button class="btn btn-secondary" onclick="performHealthTrend()" title="Health Trends">
            <i class="bi bi-graph-up-arrow"></i>
          </button>
          <button class="btn btn-secondary" onclick="scheduleAutomaticScan()" title="Schedule Scan">
            <i class="bi bi-calendar-check"></i>
          </button>
          <button class="btn btn-secondary" onclick="showSettingsModal()">
            <i class="bi bi-gear"></i> Settings
          </button>
          <button class="btn btn-secondary" onclick="testConnection()">
            <i class="bi bi-wifi"></i> Connection
          </button>
          <button class="btn btn-secondary" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-grid">
        <!-- Left Panel - Preview -->
        <section class="panel">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">Live Detection</h2>
              <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">AI-powered disease detection</p>
            </div>
            <span style="font-size: 12px; color: var(--text-secondary);">Real-time monitoring</span>
          </div>

          <!-- Input Toggle -->
          <div class="input-toggle">
            <button class="toggle-option active" onclick="switchInputMode('camera')" data-mode="camera">
              <i class="bi bi-camera"></i> Camera
            </button>
            <button class="toggle-option" onclick="switchInputMode('upload')" data-mode="upload">
              <i class="bi bi-upload"></i> Upload
            </button>
          </div>

          <div class="preview-area" id="previewArea">
            <!-- Camera Feed -->
            <div class="camera-feed" id="cameraFeed">
              <video id="cameraVideo" autoplay muted></video>
              <div class="camera-overlay">
                <i class="bi bi-circle-fill" style="color: #10b981; font-size: 8px;"></i>
                <span>LIVE</span>
                <span id="cameraTimer">00:00</span>
              </div>
              <div class="camera-controls">
                <button class="camera-btn" onclick="captureImage()" title="Capture">
                  <i class="bi bi-camera"></i>
                </button>
                <button class="camera-btn" onclick="toggleRecording()" title="Record" id="recordBtn">
                  <i class="bi bi-record-circle"></i>
                </button>
                <button class="camera-btn" onclick="stopCamera()" title="Stop">
                  <i class="bi bi-stop-circle"></i>
                </button>
              </div>
            </div>

            <!-- Upload Preview -->
            <div id="uploadPreview" style="display: none;">
              <div style="color: var(--text-secondary); text-align: center;">
                <i class="bi bi-image" style="font-size: 48px; display: block; margin-bottom: 12px;"></i>
                <p>Upload an image to begin analysis</p>
              </div>
              <img id="previewImage" style="display: none;" alt="Preview">
              <div class="image-controls">
                <button class="image-control-btn" onclick="expandImage()" title="Expand Image">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <button class="image-control-btn" onclick="downloadImage()" title="Download Image">
                  <i class="bi bi-download"></i>
                </button>
              </div>
            </div>

            <!-- Default State -->
            <div id="defaultState" style="color: var(--text-secondary); text-align: center;">
              <i class="bi bi-camera" style="font-size: 48px; display: block; margin-bottom: 12px;"></i>
              <p>Start camera to begin monitoring</p>
            </div>
          </div>

          <div style="display: flex; gap: 12px; align-items: center;">
            <button id="analyzeBtn" class="btn btn-primary" disabled onclick="analyzeImage()">
              <i class="bi bi-cpu"></i> Analyze
            </button>
            <button id="startCameraBtn" class="btn btn-success" onclick="startCamera()">
              <i class="bi bi-play-circle"></i> Start Camera
            </button>
            <button id="clearBtn" class="btn btn-secondary" onclick="clearAll()">
              <i class="bi bi-x-circle"></i> Clear
            </button>
            <button class="btn btn-secondary" onclick="showHistoryReport()">
              <i class="bi bi-graph-up"></i> Full Report
            </button>
          </div>

          <!-- Results Section -->
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Detection Results</h3>
            
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
              <span class="result-badge" id="resultBadge">No detection</span>
              <span id="diseaseLabel" style="font-weight: 600;">—</span>
            </div>
            
            <div id="confidenceSection" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 13px; font-weight: 500;">Confidence</span>
                <span id="confidenceValue" style="font-size: 13px; font-weight: 600;">—</span>
              </div>
              <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill"></div>
              </div>
            </div>
            
            <p id="diseaseDesc" style="font-size: 13px; color: var(--text-secondary); margin-top: 12px;">
              Start camera or upload an image to get started
            </p>

            <!-- Next Steps -->
            <div id="nextStepsPanel" style="display: none;">
              <div class="next-steps">
                <h5><i class="bi bi-arrow-right-circle"></i> Recommended Actions</h5>
                <div id="nextStepsList"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="showCareGuide()">
                  <i class="bi bi-book"></i> View Care Guide
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Right Panel - Controls -->
        <aside class="panel">
          <!-- Step 1: Capture -->
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
              <h4>Capture / Upload</h4>
              <p>Live camera feed or file upload</p>
              
              <!-- Camera Controls -->
              <div id="cameraControls" style="margin-bottom: 12px;">
                <button class="btn btn-success" style="width: 100%; margin-bottom: 8px;" onclick="startCamera()">
                  <i class="bi bi-camera"></i> Start Live Feed
                </button>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-secondary" style="flex: 1;" onclick="captureImage()">
                    <i class="bi bi-camera-fill"></i> Capture
                  </button>
                  <button class="btn btn-secondary" style="flex: 1;" onclick="toggleAutoCapture()">
                    <i class="bi bi-arrow-repeat"></i> Auto
                  </button>
                </div>
              </div>

              <!-- Upload Controls -->
              <div id="uploadControls" style="display: none;">
                <div class="uploader" id="uploader">
                  <input type="file" id="fileInput" accept="image/*" hidden>
                  <i class="bi bi-cloud-upload" style="font-size: 32px; color: var(--accent); display: block; margin-bottom: 8px;"></i>
                  <div style="font-weight: 600; margin-bottom: 4px;">Drop image here</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">or <span style="color: var(--accent); cursor: pointer;" onclick="document.getElementById('fileInput').click()">browse files</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Analyze -->
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
              <h4>AI Analysis</h4>
              <p>Advanced computer vision detection</p>
              <button class="btn btn-success" style="width: 100%;" onclick="analyzeImage()">
                <i class="bi bi-play-circle"></i> Start Analysis
              </button>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="toggleContinuousMode()">
                  <i class="bi bi-arrow-clockwise"></i> <span id="continuousText">Auto</span>
                </button>
                <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="saveSnapshot()">
                  <i class="bi bi-download"></i> Save
                </button>
              </div>
            </div>
          </div>

          <!-- Step 3: Enhanced History -->
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
              <h4>Detection History</h4>
              <p>Recent analysis results</p>
              
              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="showHistoryReport()">
                  <i class="bi bi-file-text"></i> Report
                </button>
                <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="exportHistory()">
                  <i class="bi bi-download"></i> Export
                </button>
              </div>
              
              <div id="historyList" style="max-height: 200px; overflow-y: auto;">
                <div style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px;">No history yet</div>
              </div>
            </div>
          </div>

          <!-- Step 4: Quick Actions -->
          <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
              <h4>Quick Actions</h4>
              <p>Emergency and routine tasks</p>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="btn btn-danger" style="font-size: 12px;" onclick="emergencyAlert()">
                  <i class="bi bi-exclamation-triangle"></i> Alert
                </button>
                <button class="btn btn-warning" style="font-size: 12px;" onclick="scheduleVisit()">
                  <i class="bi bi-calendar"></i> Schedule
                </button>
                <button class="btn btn-secondary" style="font-size: 12px;" onclick="shareResults()">
                  <i class="bi bi-share"></i> Share
                </button>
                <button class="btn btn-secondary" style="font-size: 12px;" onclick="printReport()">
                  <i class="bi bi-printer"></i> Print
                </button>
              </div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <!-- Care Guide Modal -->
    <div class="modal" id="careGuideModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 id="careGuideTitle">Disease Care Guide</h3>
          <button class="btn btn-secondary" onclick="closeCareGuide()">
            <i class="bi bi-x"></i> Close
          </button>
        </div>
        <div class="modal-content" id="careGuideContent">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
    </div>

    <!-- History Report Modal -->
    <div class="modal" id="historyReportModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3>Health Monitoring Report</h3>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="exportFullReport()">
              <i class="bi bi-download"></i> Export
            </button>
            <button class="btn btn-secondary" onclick="closeHistoryReport()">
              <i class="bi bi-x"></i> Close
            </button>
          </div>
        </div>
        <div class="modal-content" id="historyReportContent">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-container">
        <!-- Sidebar -->
        <div class="settings-sidebar">
          <div class="settings-sidebar-header">
            <h2>Settings</h2>
          </div>
          <nav class="settings-nav">
            <a class="settings-nav-item active" onclick="showSettingsSection('general')" data-section="general">
              <i class="bi bi-gear"></i>
              <span>General</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('profile')" data-section="profile">
              <i class="bi bi-person-circle"></i>
              <span>User Profile</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('wifi')" data-section="wifi">
              <i class="bi bi-wifi"></i>
              <span>Wi-Fi Settings</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('drone')" data-section="drone">
              <i class="bi bi-broadcast"></i>
              <span>Drone Settings</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('notifications')" data-section="notifications">
              <i class="bi bi-bell"></i>
              <span>Notifications</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('data')" data-section="data">
              <i class="bi bi-database"></i>
              <span>Data & Storage</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('security')" data-section="security">
              <i class="bi bi-shield-check"></i>
              <span>Security</span>
            </a>
            <a class="settings-nav-item" onclick="showSettingsSection('about')" data-section="about">
              <i class="bi bi-info-circle"></i>
              <span>About</span>
            </a>
          </nav>
        </div>

        <!-- Content -->
        <div class="settings-content">
          <div class="settings-header">
            <h3 id="settingsTitle">General</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" onclick="saveSettings()">
                <i class="bi bi-check"></i> Save
              </button>
              <button class="btn btn-secondary" onclick="closeSettingsModal()">
                <i class="bi bi-x"></i> Close
              </button>
            </div>
          </div>

          <!-- General Section -->
          <div id="general-section" class="settings-panel">
            <div class="settings-section">
              <h4>Appearance</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Theme</span>
                  <small>Choose your preferred theme</small>
                </div>
                <select class="form-select" id="theme" data-setting="theme">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                  <option value="system">System</option>
                </select>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Language</span>
                  <small>Select application language</small>
                </div>
                <select class="form-select">
                  <option>English</option>
                  <option>Afrikaans</option>
                  <option>isiZulu</option>
                  <option>Setswana</option>
                </select>
              </div>
            </div>

            <div class="settings-section">
              <h4>Analysis Settings</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Auto-analyze on capture</span>
                  <small>Automatically start analysis when image is captured</small>
                </div>
                <label class="switch">
                  <input type="checkbox" id="autoAnalyze" data-setting="autoAnalyze" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Confidence threshold</span>
                  <small>Minimum confidence level for detection</small>
                </div>
                <input type="number" class="form-input" id="confidenceThreshold" data-setting="confidenceThreshold" value="75" min="50" max="100">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Continuous monitoring</span>
                  <small>Analyze camera feed every 30 seconds</small>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Personal Information</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Farm Name</span>
                  <small>Your farm or organization name</small>
                </div>
                <input type="text" class="form-input" placeholder="Enter farm name">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Contact Email</span>
                  <small>Email for notifications and reports</small>
                </div>
                <input type="email" class="form-input" placeholder="email@example.com">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Phone Number</span>
                  <small>Contact number for alerts</small>
                </div>
                <input type="tel" class="form-input" placeholder="+27 XX XXX XXXX">
              </div>
            </div>

            <div class="settings-section">
              <h4>Farm Details</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Location</span>
                  <small>Farm location for weather data</small>
                </div>
                <input type="text" class="form-input" placeholder="City, Province">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Flock Size</span>
                  <small>Approximate number of chickens</small>
                </div>
                <input type="number" class="form-input" placeholder="1000">
              </div>
            </div>
          </div>

          <!-- Wi-Fi Section -->
          <div id="wifi-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Network Configuration</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Current Network</span>
                  <small>Connected to: FarmNet_5G</small>
                </div>
                <button class="btn btn-secondary" onclick="changeNetwork()">Change Network</button>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Auto-connect</span>
                  <small>Automatically connect to known networks</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Data Saver Mode</span>
                  <small>Reduce data usage on mobile networks</small>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="settings-section">
              <h4>Drone Connection</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Drone IP Address</span>
                  <small>IP address of the drone controller</small>
                </div>
                <input type="text" class="form-input" value="192.168.1.100">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Port</span>
                  <small>Communication port</small>
                </div>
                <input type="number" class="form-input" value="8080">
              </div>
            </div>
          </div>

          <!-- Drone Section -->
          <div id="drone-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Flight Settings</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Default Altitude</span>
                  <small>Standard flying height in meters</small>
                </div>
                <input type="number" class="form-input" value="15" min="5" max="50">
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Flight Speed</span>
                  <small>Maximum speed in km/h</small>
                </div>
                <select class="form-select">
                  <option>Slow (10 km/h)</option>
                  <option selected>Normal (20 km/h)</option>
                  <option>Fast (30 km/h)</option>
                </select>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Return to Home</span>
                  <small>Auto-return on low battery</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="settings-section">
              <h4>Camera Settings</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Image Quality</span>
                  <small>Photo resolution for analysis</small>
                </div>
                <select class="form-select">
                  <option>Standard (1080p)</option>
                  <option selected>High (4K)</option>
                  <option>Ultra (8K)</option>
                </select>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Auto-focus</span>
                  <small>Enable automatic focus adjustment</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Capture Interval</span>
                  <small>Time between automatic captures</small>
                </div>
                <input type="number" class="form-input" value="30" min="10" max="300">
              </div>
            </div>
          </div>

          <!-- Notifications Section -->
          <div id="notifications-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Alert Preferences</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Disease Detection Alerts</span>
                  <small>Notify when disease is detected</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Dead Chicken Alerts</span>
                  <small>Critical alerts for mortality detection</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Daily Reports</span>
                  <small>Receive daily health summaries</small>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- Data Section -->
          <div id="data-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Storage Management</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Local Storage</span>
                  <small>Used: 2.3 GB of 16 GB</small>
                </div>
                <button class="btn btn-secondary">Clear Cache</button>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Cloud Backup</span>
                  <small>Automatically backup detection history</small>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Export Data</span>
                  <small>Download all detection records</small>
                </div>
                <button class="btn btn-primary">Export CSV</button>
              </div>
            </div>
          </div>

          <!-- Security Section -->
          <div id="security-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Access Control</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Require PIN</span>
                  <small>PIN required to access app</small>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Biometric Login</span>
                  <small>Use fingerprint or face recognition</small>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Change Password</span>
                  <small>Update your account password</small>
                </div>
                <button class="btn btn-secondary">Change</button>
              </div>
            </div>
          </div>

          <!-- About Section -->
          <div id="about-section" class="settings-panel" style="display: none;">
            <div class="settings-section">
              <h4>Application Information</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Version</span>
                  <small>Kgosi BioDrone v2.1.0</small>
                </div>
                <span style="color: var(--success);">Up to date</span>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Model Version</span>
                  <small>TensorFlow Keras 2.15</small>
                </div>
                <span>—</span>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Support</span>
                  <small>Get help and documentation</small>
                </div>
                <button class="btn btn-secondary">Contact Support</button>
              </div>
            </div>
            
            <div class="settings-section">
              <h4>Reset Options</h4>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Reset Settings</span>
                  <small>Restore all settings to default values</small>
                </div>
                <button class="btn btn-warning" onclick="resetSettings()">
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
              </div>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Clear History</span>
                  <small>Delete all analysis history and data</small>
                </div>
                <button class="btn btn-danger" onclick="clearAllData()">
                  <i class="bi bi-trash"></i> Clear
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progressModal">
      <div class="modal-container" style="max-width: 500px;">
        <div class="modal-content" style="text-align: center; padding: 40px;">
          <div class="progress-spinner">
            <div class="spinner"></div>
          </div>
          <h3 style="margin: 24px 0 12px; font-size: 20px;" id="progressTitle">Analyzing Image</h3>
          <p style="color: var(--text-secondary); margin-bottom: 24px;" id="progressDescription">AI is processing your image for disease detection...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p id="progressText" style="font-size: 14px; margin-top: 12px; color: var(--text-secondary);">Initializing...</p>
          <div style="margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
            <span id="progressPercentage">0%</span> • <span id="progressETA">Estimating...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alertModal">
      <div class="modal-container" style="max-width: 450px;">
        <div class="modal-header">
          <h3 id="alertTitle"><i class="bi bi-info-circle"></i> Alert</h3>
          <button class="btn btn-secondary" onclick="closeAlertModal()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="modal-content">
          <p id="alertMessage">Alert message will appear here.</p>
          <div id="alertActions" style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="closeAlertModal()">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal" id="errorModal">
      <div class="modal-container" style="max-width: 400px;">
        <div class="modal-header">
          <h3><i class="bi bi-exclamation-triangle text-warning"></i> Error</h3>
          <button class="btn btn-secondary" onclick="closeErrorModal()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="modal-content">
          <p id="errorMessage">An error occurred. Please try again.</p>
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="closeErrorModal()">OK</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Image Viewer Modal -->
    <div class="modal" id="imageViewerModal">
      <div class="modal-container" style="max-width: 90vw; max-height: 90vh;">
        <div class="modal-header">
          <h3><i class="bi bi-image"></i> Image Viewer</h3>
          <button class="btn btn-secondary" onclick="closeImageViewer()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="modal-content" style="padding: 0; display: flex; justify-content: center; align-items: center; min-height: 400px;">
          <img id="fullSizeImage" style="max-width: 100%; max-height: 70vh; object-fit: contain;" alt="Full Size Preview">
        </div>
      </div>
    </div>

    <!-- Network Selection Modal -->
    <div id="networkModal" class="modal">
      <div class="modal-container" style="max-width: 400px;">
        <div class="modal-header">
          <h3>Available Networks</h3>
          <button class="btn btn-secondary" onclick="closeModal('networkModal')">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="modal-content">
          <div id="networkList" style="max-height: 300px; overflow-y: auto;">
            <!-- Networks will be populated here -->
          </div>
          <div style="margin-top: 16px; text-align: center;">
            <button onclick="refreshNetworks()" class="btn btn-secondary" style="margin-right: 8px;">Refresh</button>
            <button onclick="closeModal('networkModal')" class="btn btn-outline">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WiFi Credentials Modal -->
    <div id="wifiCredentialsModal" class="modal">
      <div class="modal-container" style="max-width: 400px;">
        <div class="modal-header">
          <h3>Connect to Network</h3>
          <button class="btn btn-secondary" onclick="closeModal('wifiCredentialsModal')">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="modal-content">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Network:</label>
            <div id="selectedNetworkName" style="padding: 8px; background: var(--bg-secondary); border-radius: 4px; font-family: monospace;"></div>
          </div>
          <div style="margin-bottom: 20px;">
            <label for="wifiPassword" style="display: block; margin-bottom: 8px; font-weight: 500;">Password:</label>
            <input type="password" id="wifiPassword" placeholder="Enter WiFi password" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
          </div>
          <div style="text-align: center;">
            <button onclick="connectWithCredentials()" class="btn btn-primary" style="margin-right: 8px;">Connect</button>
            <button onclick="closeModal('wifiCredentialsModal')" class="btn btn-outline">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Error Modal -->
    <div class="error-modal" id="cameraErrorModal">
      <h3><i class="bi bi-exclamation-triangle-fill"></i> Camera Connection Failed</h3>
      <p>Unable to establish connection with drone camera. Please check:</p>
      <ul style="font-size: 14px; color: var(--text-secondary); padding-left: 20px;">
        <li>Drone is powered on and within range</li>
        <li>Wi-Fi connection is stable (Signal strength: Weak)</li>
        <li>Camera module is properly connected</li>
        <li>Drone IP address is correct (192.168.1.100)</li>
      </ul>
      <p style="font-size: 13px; color: var(--text-secondary);">
        Error Code: CAM_TIMEOUT_001<br>
        Timestamp: <span id="errorTime"></span>
      </p>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="retryCamera()">Retry Connection</button>
        <button class="btn btn-secondary" onclick="closeCameraError()">Close</button>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Disease class mapping and care guides
      const DISEASE_DATABASE = {
        0: {
          name: 'Chicken Drinking Water',
          severity: 'healthy',
          description: 'Normal drinking behavior observed',
          nextSteps: ['Continue monitoring water quality', 'Ensure clean water supply', 'Check water temperature'],
          care: {
            immediate: 'No action required - normal behavior',
            daily: 'Monitor water consumption levels',
            weekly: 'Clean and sanitize water systems',
            prevention: 'Maintain consistent water quality and temperature'
          }
        },
        1: {
          name: 'Chicken Feeding',
          severity: 'healthy',
          description: 'Normal feeding behavior detected',
          nextSteps: ['Monitor feed consumption rates', 'Check feed quality', 'Ensure adequate feed supply'],
          care: {
            immediate: 'No action required - normal behavior',
            daily: 'Track feed consumption patterns',
            weekly: 'Rotate feed stocks and check freshness',
            prevention: 'Maintain proper feed storage conditions'
          }
        },
        2: {
          name: 'avian_influenza',
          severity: 'critical',
          description: 'Highly contagious viral infection detected',
          nextSteps: ['IMMEDIATE QUARANTINE', 'Contact veterinarian urgently', 'Notify authorities', 'Test all birds'],
          care: {
            immediate: 'Isolate affected birds immediately, implement strict biosecurity',
            daily: 'Monitor all birds for symptoms, maintain quarantine protocols',
            weekly: 'Continue monitoring, follow veterinary treatment plan',
            prevention: 'Vaccination programs, strict biosecurity, limit visitor access'
          }
        },
        3: {
          name: 'dead_chickens',
          severity: 'critical',
          description: 'Mortality detected - immediate investigation required',
          nextSteps: ['Remove carcasses immediately', 'Investigate cause of death', 'Check other birds', 'Contact vet'],
          care: {
            immediate: 'Remove and properly dispose of carcasses, examine remaining flock',
            daily: 'Intensive monitoring of remaining birds for 14 days',
            weekly: 'Continue health surveillance, document all findings',
            prevention: 'Regular health checks, vaccination schedules, stress reduction'
          }
        },
        4: {
          name: 'gumboro_disease',
          severity: 'warning',
          description: 'Infectious bursal disease affecting immune system',
          nextSteps: ['Isolate affected birds', 'Provide supportive care', 'Contact veterinarian', 'Review vaccination'],
          care: {
            immediate: 'Isolate affected birds, provide clean environment',
            daily: 'Supportive care, monitor hydration and nutrition',
            weekly: 'Follow vaccination protocol, maintain biosecurity',
            prevention: 'Proper vaccination timing, stress management, clean facilities'
          }
        },
        5: {
          name: 'healthy',
          severity: 'healthy',
          description: 'Birds appear healthy with no signs of disease',
          nextSteps: ['Continue routine monitoring', 'Maintain current care practices', 'Schedule routine check'],
          care: {
            immediate: 'No action required',
            daily: 'Continue normal feeding and care routine',
            weekly: 'Regular health observations, maintain clean environment',
            prevention: 'Consistent care practices, vaccination schedules'
          }
        },
        6: {
          name: 'healthy_chicken',
          severity: 'healthy',
          description: 'Individual bird showing good health indicators',
          nextSteps: ['Continue monitoring', 'Maintain nutrition program', 'Regular health checks'],
          care: {
            immediate: 'No action required',
            daily: 'Normal feeding and care routine',
            weekly: 'Health monitoring, environmental checks',
            prevention: 'Balanced nutrition, clean environment, regular exercise'
          }
        },
        7: {
          name: 'infectious_coryza',
          severity: 'warning',
          description: 'Bacterial respiratory infection detected',
          nextSteps: ['Isolate affected birds', 'Antibiotic treatment', 'Improve ventilation', 'Contact vet'],
          care: {
            immediate: 'Isolate birds, improve air quality and ventilation',
            daily: 'Administer prescribed antibiotics, monitor breathing',
            weekly: 'Continue treatment course, environmental improvements',
            prevention: 'Good ventilation, reduce stress, vaccination programs'
          }
        },
        8: {
          name: 'new_castles_disease',
          severity: 'critical',
          description: 'Highly contagious viral disease affecting nervous system',
          nextSteps: ['EMERGENCY QUARANTINE', 'Contact authorities', 'Veterinary consultation', 'Cull if necessary'],
          care: {
            immediate: 'Complete quarantine, contact veterinary and health authorities',
            daily: 'Strict isolation, no movement of birds or equipment',
            weekly: 'Follow official control measures, monitoring protocols',
            prevention: 'Vaccination programs, strict biosecurity, regular health monitoring'
          }
        },
        9: {
          name: 'splay_foot',
          severity: 'warning',
          description: 'Developmental leg deformity affecting mobility',
          nextSteps: ['Assess severity', 'Provide supportive care', 'Adjust housing', 'Monitor mobility'],
          care: {
            immediate: 'Provide non-slip surfaces, assess bird mobility',
            daily: 'Monitor eating and drinking ability, provide easy access',
            weekly: 'Evaluate quality of life, consider housing modifications',
            prevention: 'Proper incubation conditions, appropriate flooring, genetic selection'
          }
        }
      };

      let selectedFile = null;
      let analysisHistory = [];
      let currentInputMode = 'camera';
      let cameraStream = null;
      let isRecording = false;
      let continuousMode = false;
      let autoCapture = false;
      let cameraTimer = 0;
      let timerInterval = null;

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure DOM is fully loaded
        setTimeout(() => {
          updateInputMode();
          initializeTooltips();
          updateSystemStatus();
          loadHistoryFromBackend();
        }, 100);
      });
      
      // Load analysis history from backend
      function loadHistoryFromBackend() {
        fetch('/history')
        .then(response => response.json())
        .then(data => {
          if (data.history && data.history.length > 0) {
            // Convert backend history format to frontend format
            analysisHistory = data.history.map(item => {
              // Map backend disease names to frontend disease database
              let diseaseData = null;
              for (let key in DISEASE_DATABASE) {
                if (DISEASE_DATABASE[key].name.toLowerCase().includes(item.disease.toLowerCase()) ||
                    item.disease.toLowerCase().includes(DISEASE_DATABASE[key].name.toLowerCase())) {
                  diseaseData = DISEASE_DATABASE[key];
                  break;
                }
              }
              
              if (!diseaseData) {
                diseaseData = {
                  name: item.disease,
                  severity: item.disease.includes('dead') || item.disease.includes('avian') || item.disease.includes('newcastle') ? 'critical' :
                           item.disease.includes('gumboro') || item.disease.includes('coryza') || item.disease.includes('splay') ? 'warning' : 'healthy',
                  description: `${item.disease} detected by AI analysis`
                };
              }
              
              return {
                id: Date.now() + Math.random(),
                disease: item.disease,
                severity: diseaseData.severity,
                confidence: 85, // Default confidence
                timestamp: new Date(item.timestamp),
                timestampStr: new Date(item.timestamp).toLocaleString(),
                description: diseaseData.description,
                diseaseData: diseaseData
              };
            });
            
            updateHistoryDisplay();
          }
        })
        .catch(error => {
          console.warn('Failed to load history from backend:', error);
        });
      }

      // Initialize tooltips for better UX
      function initializeTooltips() {
        const elementsWithTitles = document.querySelectorAll('[title]');
        elementsWithTitles.forEach(element => {
          element.addEventListener('mouseenter', function() {
            const titleText = this.getAttribute('title');
            if (titleText) {
              const tooltip = document.createElement('div');
              tooltip.textContent = titleText;
              tooltip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 1000;
                pointer-events: none;
              `;
              document.body.appendChild(tooltip);
              
              this.addEventListener('mouseleave', () => {
                if (tooltip.parentNode) {
                  tooltip.remove();
                }
              }, { once: true });
            }
          });
        });
      }

      // Input Mode Toggle
      function switchInputMode(mode) {
        currentInputMode = mode;
        
        // Update toggle buttons
        document.querySelectorAll('.toggle-option').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        
        updateInputMode();
      }

      function updateInputMode() {
        const cameraControls = document.getElementById('cameraControls');
        const uploadControls = document.getElementById('uploadControls');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const previewArea = document.getElementById('previewArea');
        
        if (currentInputMode === 'camera') {
          cameraControls.style.display = 'block';
          uploadControls.style.display = 'none';
          startCameraBtn.style.display = 'inline-flex';
          
          // Reset to camera view
          document.getElementById('cameraFeed').style.display = 'none';
          document.getElementById('uploadPreview').style.display = 'none';
          document.getElementById('defaultState').style.display = 'block';
        } else {
          cameraControls.style.display = 'none';
          uploadControls.style.display = 'block';
          startCameraBtn.style.display = 'none';
          
          // Reset to upload view
          document.getElementById('cameraFeed').style.display = 'none';
          document.getElementById('defaultState').style.display = 'none';
          document.getElementById('uploadPreview').style.display = 'block';
          
          // Reset upload preview
          document.getElementById('previewImage').style.display = 'none';
          document.getElementById('uploadPreview').querySelector('div').style.display = 'block';
        }
        
        // Reset preview area size and selected file
        previewArea.classList.remove('expanded');
        selectedFile = null;
        resetFileInput();
        document.getElementById('analyzeBtn').disabled = true;
      }

      // Camera Functions
      async function startCamera() {
        try {
          const cameraFeed = document.getElementById('cameraFeed');
          const defaultState = document.getElementById('defaultState');
          const video = document.getElementById('cameraVideo');
          
          defaultState.style.display = 'none';
          cameraFeed.style.display = 'block';
          
          // Start timer
          startTimer();
          
          // Play camera feed video
          video.src = '/static/camerafeed.mp4';
          video.style.background = 'none';
          video.play();
          
          // Stop video after 10 seconds and show error
          setTimeout(() => {
            video.pause();
            video.style.display = 'none';
            
            // Show "no chickens detected" error with tips
            const errorOverlay = document.createElement('div');
            errorOverlay.style.cssText = `
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.8);
              color: white;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              text-align: center;
              padding: 20px;
              border-radius: 8px;
            `;
            
            errorOverlay.innerHTML = `
              <i class="bi bi-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;"></i>
              <h4 style="margin: 0 0 12px; color: white;">No Chickens Detected</h4>
              <p style="margin: 0 0 16px; font-size: 14px; opacity: 0.9;">Unable to detect chickens in the camera feed</p>
              <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h6 style="margin: 0 0 8px; color: #fbbf24;">💡 Tips to Fix:</h6>
                <ul style="margin: 0; padding-left: 20px; font-size: 13px; text-align: left;">
                  <li>Ensure chickens are visible in the camera frame</li>
                  <li>Check camera angle and positioning</li>
                  <li>Improve lighting conditions</li>
                  <li>Move camera closer to the flock</li>
                  <li>Wait for chickens to move into view</li>
                </ul>
              </div>
              <button class="btn btn-primary" onclick="this.parentElement.remove(); startCamera()" style="margin-right: 8px;">
                <i class="bi bi-arrow-clockwise"></i> Retry
              </button>
              <button class="btn btn-secondary" onclick="this.parentElement.remove(); stopCamera()">
                <i class="bi bi-x-circle"></i> Stop Camera
              </button>
            `;
            
            cameraFeed.appendChild(errorOverlay);
          }, 10000);
          
          // Start auto-capture if enabled
          if (autoCapture) {
            startAutoCaptureMode();
          }
          
        } catch (error) {
          showCameraError();
        }
      }

      function stopCamera() {
        const cameraFeed = document.getElementById('cameraFeed');
        const defaultState = document.getElementById('defaultState');
        
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        
        cameraFeed.style.display = 'none';
        defaultState.style.display = 'block';
        
        stopTimer();
        document.getElementById('analyzeBtn').disabled = true;
        
        if (autoCapture) {
          stopAutoCaptureMode();
        }
      }

      function captureImage() {
        if (currentInputMode === 'camera') {
          // Check if camera is started
          const cameraFeed = document.getElementById('cameraFeed');
          if (cameraFeed.style.display === 'none' || cameraFeed.style.display === '') {
            showErrorModal('Camera Not Started', 'Please start the camera before capturing an image.');
            return;
          }
          
          // Simulate camera capture
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 640;
          canvas.height = 480;
          
          // Create gradient placeholder
          const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
          gradient.addColorStop(0, '#4ade80');
          gradient.addColorStop(1, '#22c55e');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Add text
          ctx.fillStyle = 'white';
          ctx.font = '24px Inter';
          ctx.textAlign = 'center';
          ctx.fillText('Captured Frame', canvas.width/2, canvas.height/2);
          ctx.font = '16px Inter';
          ctx.fillText(new Date().toLocaleTimeString(), canvas.width/2, canvas.height/2 + 30);
          
          // Convert to blob and display
          canvas.toBlob(blob => {
            selectedFile = blob;
            const url = URL.createObjectURL(blob);
            
            // Switch to upload preview to show captured image
            document.getElementById('cameraFeed').style.display = 'none';
            document.getElementById('uploadPreview').style.display = 'block';
            document.getElementById('previewImage').src = url;
            document.getElementById('previewImage').style.display = 'block';
            document.getElementById('uploadPreview').querySelector('div').style.display = 'none';
            
            // Enable analyze button when image is captured
            document.getElementById('analyzeBtn').disabled = false;
            
            // Auto-analyze if enabled
            const autoAnalyzeSetting = document.getElementById('autoAnalyze');
            if (autoAnalyzeSetting && autoAnalyzeSetting.checked) {
              setTimeout(analyzeImage, 1000);
            }
          });
        }
      }

      function toggleRecording() {
        const recordBtn = document.getElementById('recordBtn');
        isRecording = !isRecording;
        
        if (isRecording) {
          recordBtn.innerHTML = '<i class="bi bi-stop-circle-fill"></i>';
          recordBtn.style.background = 'rgba(239, 68, 68, 0.9)';
        } else {
          recordBtn.innerHTML = '<i class="bi bi-record-circle"></i>';
          recordBtn.style.background = 'rgba(255,255,255,0.9)';
        }
      }

      function toggleAutoCapture() {
        autoCapture = !autoCapture;
        const btn = event.target.closest('button');
        
        if (autoCapture) {
          btn.innerHTML = '<i class="bi bi-pause-circle"></i> Stop';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-warning');
          if (currentInputMode === 'camera') {
            startAutoCaptureMode();
          }
        } else {
          btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Auto';
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-secondary');
          stopAutoCaptureMode();
        }
      }

      function toggleContinuousMode() {
        continuousMode = !continuousMode;
        const btn = event.target.closest('button');
        const text = btn.querySelector('span') || btn;
        
        if (continuousMode) {
          if (btn.querySelector('span')) {
            text.textContent = 'Stop';
          } else {
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Stop';
          }
          btn.classList.add('btn-warning');
          btn.classList.remove('btn-secondary');
          
          if (currentInputMode === 'camera') {
            startContinuousAnalysis();
          }
        } else {
          if (btn.querySelector('span')) {
            text.textContent = 'Auto';
          } else {
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Auto';
          }
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-warning');
          stopContinuousAnalysis();
        }
      }

      function startAutoCaptureMode() {
        if (autoCapture && currentInputMode === 'camera') {
          setTimeout(() => {
            if (autoCapture) {
              captureImage();
              if (document.querySelector('[type="checkbox"]').checked) { // auto-analyze setting
                setTimeout(analyzeImage, 1000);
              }
              startAutoCaptureMode(); // Continue loop
            }
          }, 30000); // 30 seconds
        }
      }

      function stopAutoCaptureMode() {
        autoCapture = false;
      }

      function startTimer() {
        cameraTimer = 0;
        timerInterval = setInterval(() => {
          cameraTimer++;
          const minutes = Math.floor(cameraTimer / 60).toString().padStart(2, '0');
          const seconds = (cameraTimer % 60).toString().padStart(2, '0');
          document.getElementById('cameraTimer').textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // File handling
      const fileInput = document.getElementById('fileInput');
      const uploader = document.getElementById('uploader');

      // Drag and drop
      uploader.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploader.classList.add('dragover');
      });

      uploader.addEventListener('dragleave', () => {
        uploader.classList.remove('dragover');
      });

      uploader.addEventListener('drop', (e) => {
        e.preventDefault();
        uploader.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      uploader.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });
      
      // Reset file input when needed
      function resetFileInput() {
        fileInput.value = '';
        selectedFile = null;
      }

      function handleFile(file) {
        if (!file.type.startsWith('image/')) {
          showErrorModal('Invalid File', 'Please upload an image file (JPG, PNG, etc.)');
          return;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          showErrorModal('File Too Large', 'Please upload an image smaller than 10MB');
          return;
        }

        selectedFile = file;
        const reader = new FileReader();
        
        reader.onload = (e) => {
          // Switch to upload preview mode
          document.getElementById('cameraFeed').style.display = 'none';
          document.getElementById('defaultState').style.display = 'none';
          document.getElementById('uploadPreview').style.display = 'block';
          
          const previewImage = document.getElementById('previewImage');
          previewImage.src = e.target.result;
          previewImage.style.display = 'block';
          document.getElementById('uploadPreview').querySelector('div').style.display = 'none';
          document.getElementById('analyzeBtn').disabled = false;
          
          // Expand preview area for better image viewing
          document.getElementById('previewArea').classList.add('expanded');
          
          showNotification(`Image uploaded: ${file.name}`, 'success', 3000);
        };
        
        reader.readAsDataURL(file);
      }
      
      // Image control functions
      function expandImage() {
        const previewImage = document.getElementById('previewImage');
        if (previewImage.src) {
          document.getElementById('fullSizeImage').src = previewImage.src;
          document.getElementById('imageViewerModal').classList.add('show');
        }
      }
      
      function closeImageViewer() {
        document.getElementById('imageViewerModal').classList.remove('show');
      }
      
      function downloadImage() {
        const previewImage = document.getElementById('previewImage');
        if (previewImage.src && selectedFile) {
          const link = document.createElement('a');
          link.download = selectedFile.name || 'image.jpg';
          link.href = previewImage.src;
          link.click();
        }
      }

      function clearAll() {
        selectedFile = null;
        
        // Reset preview areas
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('uploadPreview').querySelector('div').style.display = 'block';
        document.getElementById('cameraFeed').style.display = 'none';
        document.getElementById('defaultState').style.display = 'block';
        
        // Reset preview area size
        document.getElementById('previewArea').classList.remove('expanded');
        
        document.getElementById('analyzeBtn').disabled = true;
        resetResults();
        
        if (cameraStream) {
          stopCamera();
        }
      }

      function resetResults() {
        document.getElementById('resultBadge').textContent = 'No detection';
        document.getElementById('resultBadge').style.background = '#e6fffb';
        document.getElementById('resultBadge').style.color = '#064e3b';
        document.getElementById('diseaseLabel').textContent = '—';
        document.getElementById('diseaseDesc').textContent = 'Start camera or upload an image to get started';
        document.getElementById('confidenceSection').style.display = 'none';
        document.getElementById('nextStepsPanel').style.display = 'none';
      }

      // Enhanced Analysis with Backend Integration
      function analyzeImage() {
        const previewImage = document.getElementById('previewImage');
        const hasImage = selectedFile || (previewImage && previewImage.src && previewImage.src !== window.location.href);
        
        if (!hasImage) {
          if (currentInputMode === 'upload') {
            showErrorModal('No Image Selected', 'Please upload an image before starting analysis.');
          } else {
            showErrorModal('No Image Captured', 'Please capture an image from the camera first.');
          }
          return;
        }

        // Show progress modal
        showProgressModal();
        
        // Disable analyze button
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('loading');

        // Prepare form data for backend
        const formData = new FormData();
        
        if (selectedFile) {
          formData.append('file', selectedFile);
        } else {
          // Convert canvas/preview image to blob for camera captures
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = document.getElementById('previewImage');
          
          canvas.width = img.naturalWidth || 640;
          canvas.height = img.naturalHeight || 480;
          ctx.drawImage(img, 0, 0);
          
          canvas.toBlob(blob => {
            formData.append('file', blob, 'capture.jpg');
            sendAnalysisRequest(formData, analyzeBtn);
          }, 'image/jpeg', 0.8);
          return;
        }
        
        sendAnalysisRequest(formData, analyzeBtn);
      }
      
      function sendAnalysisRequest(formData, analyzeBtn) {
        // Start progress simulation
        simulateAnalysisProgress();
        
        fetch('/analyze', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          hideProgressModal();
          
          if (data.error) {
            if (data.error === 'No chicken detected') {
              showErrorModal('No Chicken Detected', 'No chickens were found in the image. Please ensure chickens are visible and try again.');
            } else {
              showErrorModal('Analysis Error', data.error);
            }
            return;
          }
          
          // Process successful response
          const diseaseData = DISEASE_DATABASE[data.class_id] || {
            name: data.disease,
            severity: 'unknown',
            description: 'Disease detected by AI model',
            nextSteps: ['Consult veterinarian', 'Monitor affected birds', 'Implement biosecurity measures'],
            care: {
              immediate: 'Isolate affected birds and consult veterinarian',
              daily: 'Monitor symptoms and provide supportive care',
              weekly: 'Follow veterinary treatment plan',
              prevention: 'Maintain good hygiene and vaccination schedules'
            }
          };
          
          const confidence = Math.round(data.confidence * 100);
          
          // Update UI with real results
          updateResults(diseaseData, confidence);
          
          // Add to history
          addToHistory(diseaseData, confidence);
          
          // Update preview with annotated image if available
          if (data.image_url) {
            document.getElementById('previewImage').src = data.image_url;
          }
          
        })
        .catch(error => {
          hideProgressModal();
          console.error('Analysis error:', error);
          showErrorModal('Connection Error', 'Failed to connect to the analysis server. Please check your connection and try again.');
        })
        .finally(() => {
          analyzeBtn.disabled = false;
          analyzeBtn.classList.remove('loading');
        });
      }

      // Progress Modal Functions
      function showProgressModal() {
        const modal = document.getElementById('progressModal');
        modal.classList.add('show');
        
        // Reset progress
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = 'Initializing...';
        document.getElementById('progressPercentage').textContent = '0%';
        document.getElementById('progressETA').textContent = 'Estimating...';
      }

      function hideProgressModal() {
        document.getElementById('progressModal').classList.remove('show');
      }

      function updateProgress(percentage, text, eta = null) {
        document.getElementById('progressFill').style.width = percentage + '%';
        document.getElementById('progressText').textContent = text;
        document.getElementById('progressPercentage').textContent = percentage + '%';
        if (eta) {
          document.getElementById('progressETA').textContent = eta;
        }
      }

      // Simulate realistic analysis progress
      async function simulateAnalysisProgress() {
        const steps = [
          { text: 'Preprocessing image...', duration: 800, progress: 15 },
          { text: 'Loading AI model...', duration: 600, progress: 30 },
          { text: 'Extracting features...', duration: 1000, progress: 55 },
          { text: 'Running inference...', duration: 1200, progress: 80 },
          { text: 'Analyzing results...', duration: 600, progress: 95 },
          { text: 'Finalizing detection...', duration: 400, progress: 100 }
        ];

        let totalTime = steps.reduce((sum, step) => sum + step.duration, 0);
        let elapsed = 0;

        for (let i = 0; i < steps.length; i++) {
          const step = steps[i];
          const remainingTime = Math.max(0, totalTime - elapsed);
          const eta = remainingTime > 1000 ? `${Math.ceil(remainingTime/1000)}s remaining` : 'Almost done...';
          
          updateProgress(step.progress, step.text, eta);
          
          await new Promise(resolve => setTimeout(resolve, step.duration));
          elapsed += step.duration;
        }
      }

      function updateResults(diseaseData, confidence) {
        const resultBadge = document.getElementById('resultBadge');
        const diseaseLabel = document.getElementById('diseaseLabel');
        const diseaseDesc = document.getElementById('diseaseDesc');
        
        resultBadge.textContent = diseaseData.name;
        diseaseLabel.textContent = diseaseData.name;
        diseaseDesc.textContent = diseaseData.description;

        // Update badge color based on severity
        if (diseaseData.severity === 'healthy') {
          resultBadge.style.background = '#dcfce7';
          resultBadge.style.color = '#166534';
        } else if (diseaseData.severity === 'warning') {
          resultBadge.style.background = '#fef3c7';
          resultBadge.style.color = '#92400e';
        } else if (diseaseData.severity === 'critical') {
          resultBadge.style.background = '#fee2e2';
          resultBadge.style.color = '#991b1b';
        }

        // Show confidence
        document.getElementById('confidenceSection').style.display = 'block';
        document.getElementById('confidenceValue').textContent = confidence + '%';
        document.getElementById('confidenceFill').style.width = confidence + '%';

        // Show next steps
        showNextSteps(diseaseData);
      }

      function showNextSteps(diseaseData) {
        const nextStepsPanel = document.getElementById('nextStepsPanel');
        const nextStepsList = document.getElementById('nextStepsList');
        
        nextStepsList.innerHTML = diseaseData.nextSteps.map((step, index) => `
          <div class="step-item">
            <div class="step-icon">${index + 1}</div>
            <span>${step}</span>
          </div>
        `).join('');
        
        nextStepsPanel.style.display = 'block';
      }

      // History Management
      function addToHistory(diseaseData, confidence) {
        const timestamp = new Date();
        const historyItem = {
          id: Date.now(),
          disease: diseaseData.name,
          severity: diseaseData.severity,
          confidence: confidence,
          timestamp: timestamp,
          timestampStr: timestamp.toLocaleString(),
          description: diseaseData.description,
          diseaseData: diseaseData
        };
        
        analysisHistory.unshift(historyItem);
        
        // Keep only last 50 items
        if (analysisHistory.length > 50) {
          analysisHistory.pop();
        }

        updateHistoryDisplay();
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        
        if (analysisHistory.length === 0) {
          historyList.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px;">No history yet</div>';
          return;
        }

        historyList.innerHTML = analysisHistory.slice(0, 10).map(item => `
          <div class="history-item" onclick="showHistoryDetails(${item.id})">
            <div class="history-header">
              <span style="font-weight: 600; font-size: 14px;">${item.disease}</span>
              <span class="severity-badge severity-${item.severity}">${item.severity}</span>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
              ${item.timestampStr} • Confidence: ${item.confidence}%
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">
              ${item.description.substring(0, 60)}${item.description.length > 60 ? '...' : ''}
            </div>
          </div>
        `).join('');
      }

      function showHistoryDetails(id) {
        const item = analysisHistory.find(h => h.id === id);
        if (item) {
          showCareGuide(item.diseaseData);
        }
      }

      // Care Guide Modal
      function showCareGuide(diseaseData = null) {
        if (!diseaseData && analysisHistory.length > 0) {
          diseaseData = analysisHistory[0].diseaseData;
        }
        
        if (!diseaseData) {
          alert('Please analyze an image first');
          return;
        }

        const modal = document.getElementById('careGuideModal');
        const title = document.getElementById('careGuideTitle');
        const content = document.getElementById('careGuideContent');
        
        title.textContent = `${diseaseData.name} - Care Guide`;
        
        content.innerHTML = `
          <div class="care-section">
            <h4><i class="bi bi-info-circle"></i> Overview</h4>
            <p style="font-size: 14px; margin-bottom: 20px;">${diseaseData.description}</p>
          </div>

          <div class="care-section">
            <h4><i class="bi bi-clock"></i> Care Timeline</h4>
            <div class="timeline">
              <div class="timeline-item">
                <h6 style="color: var(--danger); margin-bottom: 8px;">Immediate (0-24 hours)</h6>
                <p style="font-size: 13px;">${diseaseData.care.immediate}</p>
              </div>
              <div class="timeline-item">
                <h6 style="color: var(--warning); margin-bottom: 8px;">Daily (1-7 days)</h6>
                <p style="font-size: 13px;">${diseaseData.care.daily}</p>
              </div>
              <div class="timeline-item">
                <h6 style="color: var(--accent); margin-bottom: 8px;">Weekly (1-4 weeks)</h6>
                <p style="font-size: 13px;">${diseaseData.care.weekly}</p>
              </div>
              <div class="timeline-item">
                <h6 style="color: var(--success); margin-bottom: 8px;">Prevention</h6>
                <p style="font-size: 13px;">${diseaseData.care.prevention}</p>
              </div>
            </div>
          </div>

          <div class="care-section">
            <h4><i class="bi bi-list-check"></i> Action Items</h4>
            <div class="care-grid">
              ${diseaseData.nextSteps.map((step, index) => `
                <div class="care-card">
                  <h6>Step ${index + 1}</h6>
                  <p>${step}</p>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="care-section">
            <h4><i class="bi bi-telephone"></i> Emergency Contacts</h4>
            <div class="care-grid">
              <div class="care-card">
                <h6>Local Veterinarian</h6>
                <p>Dr. - <br>+27 11 123 4567</p>
              </div>
              <div class="care-card">
                <h6>Animal Health Authority</h6>
                <p>Department of Agriculture<br>-</p>
              </div>
              <div class="care-card">
                <h6>Emergency Hotline</h6>
                <p>24/7 Poultry Health<br>-</p>
              </div>
            </div>
          </div>
        `;
        
        modal.classList.add('show');
      }

      function closeCareGuide() {
        document.getElementById('careGuideModal').classList.remove('show');
      }

      // History Report Modal
      function showHistoryReport() {
        const modal = document.getElementById('historyReportModal');
        const content = document.getElementById('historyReportContent');
        
        if (analysisHistory.length === 0) {
          content.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No analysis history available</p>';
        } else {
          const stats = generateHealthStats();
          content.innerHTML = `
            <div class="care-section">
              <h4><i class="bi bi-graph-up"></i> Health Statistics</h4>
              <div class="care-grid">
                <div class="care-card">
                  <h6>Total Analyses</h6>
                  <p style="font-size: 24px; font-weight: 700; color: var(--accent);">${stats.total}</p>
                </div>
                <div class="care-card">
                  <h6>Healthy Detections</h6>
                  <p style="font-size: 24px; font-weight: 700; color: var(--success);">${stats.healthy}</p>
                </div>
                <div class="care-card">
                  <h6>Warnings</h6>
                  <p style="font-size: 24px; font-weight: 700; color: var(--warning);">${stats.warnings}</p>
                </div>
                <div class="care-card">
                  <h6>Critical Issues</h6>
                  <p style="font-size: 24px; font-weight: 700; color: var(--danger);">${stats.critical}</p>
                </div>
              </div>
            </div>

            <div class="care-section">
              <h4><i class="bi bi-clock-history"></i> Recent Activity</h4>
              ${analysisHistory.slice(0, 15).map(item => `
                <div class="history-item" onclick="showHistoryDetails(${item.id})">
                  <div class="history-header">
                    <span style="font-weight: 600;">${item.disease}</span>
                    <span class="severity-badge severity-${item.severity}">${item.severity}</span>
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    ${item.timestampStr} • Confidence: ${item.confidence}%
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    ${item.description}
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="care-section">
              <h4><i class="bi bi-exclamation-triangle"></i> Health Alerts</h4>
              <div class="care-card" style="border-left: 4px solid var(--warning);">
                <h6>Monitoring Recommendations</h6>
                <p>${generateHealthRecommendations()}</p>
              </div>
            </div>
          `;
        }
        
        modal.classList.add('show');
      }

      function closeHistoryReport() {
        document.getElementById('historyReportModal').classList.remove('show');
      }

      function generateHealthStats() {
        const stats = {
          total: analysisHistory.length,
          healthy: 0,
          warnings: 0,
          critical: 0
        };

        analysisHistory.forEach(item => {
          if (item.severity === 'healthy') stats.healthy++;
          else if (item.severity === 'warning') stats.warnings++;
          else if (item.severity === 'critical') stats.critical++;
        });

        return stats;
      }

      function generateHealthRecommendations() {
        const stats = generateHealthStats();
        
        if (stats.critical > 0) {
          return 'Critical issues detected in recent analyses. Immediate veterinary consultation recommended. Implement strict biosecurity measures.';
        } else if (stats.warnings > 2) {
          return 'Multiple warning signs detected. Consider preventive measures and schedule routine veterinary check-up.';
        } else if (stats.healthy > 5) {
          return 'Flock health appears good. Continue current management practices and routine monitoring.';
        } else {
          return 'Insufficient data for comprehensive assessment. Continue regular monitoring for better insights.';
        }
      }

      // Utility Functions
      function toggleContinuousMode() {
        continuousMode = !continuousMode;
        const btn = event.target;
        const text = document.getElementById('continuousText');
        
        if (continuousMode) {
          text.textContent = 'Stop';
          btn.classList.add('btn-warning');
          btn.classList.remove('btn-secondary');
          
          if (currentInputMode === 'camera') {
            startContinuousAnalysis();
          }
        } else {
          text.textContent = 'Auto';
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-warning');
          stopContinuousAnalysis();
        }
      }

      function startContinuousAnalysis() {
        if (continuousMode) {
          setTimeout(() => {
            if (continuousMode && currentInputMode === 'camera') {
              analyzeImage();
              startContinuousAnalysis();
            }
          }, 45000); // Every 45 seconds
        }
      }

      function stopContinuousAnalysis() {
        continuousMode = false;
      }

      function saveSnapshot() {
        if (selectedFile) {
          const link = document.createElement('a');
          link.download = `poultry_snapshot_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.jpg`;
          link.href = URL.createObjectURL(selectedFile);
          link.click();
        } else {
          alert('No image to save');
        }
      }

      function exportHistory() {
        fetch('/export/history?format=csv')
        .then(response => {
          if (response.ok) {
            return response.text();
          } else {
            throw new Error('Export failed');
          }
        })
        .then(csvContent => {
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const link = document.createElement('a');
          link.download = `poultry_health_history_${new Date().toISOString().slice(0,10)}.csv`;
          link.href = URL.createObjectURL(blob);
          link.click();
          showNotification('History exported successfully', 'success');
        })
        .catch(error => {
          console.error('Export error:', error);
          // Fallback to local export
          if (analysisHistory.length === 0) {
            showErrorModal('No Data', 'No history to export');
            return;
          }

          const csvContent = 'Date,Disease,Severity,Confidence,Description\n' + 
            analysisHistory.map(item => 
              `"${item.timestampStr}","${item.disease}","${item.severity}","${item.confidence}%","${item.description}"`
            ).join('\n');

          const blob = new Blob([csvContent], { type: 'text/csv' });
          const link = document.createElement('a');
          link.download = `poultry_health_history_${new Date().toISOString().slice(0,10)}.csv`;
          link.href = URL.createObjectURL(blob);
          link.click();
          showNotification('History exported locally', 'warning');
        });
      }

      function exportFullReport() {
        const stats = generateHealthStats();
        const reportContent = `
# Kgosi BioDrone Health Report
Generated: ${new Date().toLocaleString()}

## Summary Statistics
- Total Analyses: ${stats.total}
- Healthy Detections: ${stats.healthy}
- Warning Signs: ${stats.warnings} 
- Critical Issues: ${stats.critical}

## Health Recommendations
${generateHealthRecommendations()}

## Recent Detections
${analysisHistory.slice(0, 20).map(item => 
  `- ${item.timestampStr}: ${item.disease} (${item.confidence}% confidence) - ${item.severity.toUpperCase()}`
).join('\n')}

---
Report generated by Kgosi BioDrone v2.1.0
        `.trim();

        const blob = new Blob([reportContent], { type: 'text/markdown' });
        const link = document.createElement('a');
        link.download = `poultry_health_report_${new Date().toISOString().slice(0,10)}.md`;
        link.href = URL.createObjectURL(blob);
        link.click();
      }

      // Quick Actions with Backend Integration
      function emergencyAlert() {
        const alertData = {
          type: 'emergency',
          message: 'Emergency alert from Kgosi BioDrone - Immediate attention required'
        };
        
        fetch('/alert/emergency', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(alertData)
        })
        .then(response => response.json())
        .then(data => {
          showNotification('🚨 Emergency alert sent to veterinarian and authorities', 'error', 6000);
          
          const alertModal = document.createElement('div');
          alertModal.className = 'error-modal show';
          alertModal.innerHTML = `
            <h3><i class="bi bi-exclamation-triangle-fill"></i> Emergency Alert Sent</h3>
            <p>Emergency notification has been sent to:</p>
            <ul style="font-size: 14px; margin: 16px 0;">
              ${data.recipients.map(recipient => `<li>${recipient}</li>`).join('')}
            </ul>
            <p style="font-size: 13px; color: var(--text-secondary);">
              Alert ID: ${data.alert_id}<br>
              Priority: HIGH<br>
              Status: DELIVERED<br>
              Timestamp: ${new Date(data.timestamp).toLocaleString()}
            </p>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">Close</button>
              <button class="btn btn-secondary" onclick="showCareGuide()">View Care Guide</button>
            </div>
          `;
          document.body.appendChild(alertModal);
          
          setTimeout(() => {
            if (alertModal.parentNode) {
              alertModal.remove();
            }
          }, 8000);
        })
        .catch(error => {
          console.error('Emergency alert error:', error);
          showNotification('⚠️ Failed to send emergency alert. Please contact authorities directly.', 'error', 8000);
        });
      }

      function scheduleVisit() {
        const scheduleData = {
          type: 'veterinary_visit',
          time: '10:00',
          date: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0] // Tomorrow
        };
        
        fetch('/schedule', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(scheduleData)
        })
        .then(response => response.json())
        .then(data => {
          showNotification('📅 Veterinary visit scheduled successfully', 'success');
          
          const scheduleModal = document.createElement('div');
          scheduleModal.className = 'error-modal show';
          scheduleModal.innerHTML = `
            <h3><i class="bi bi-calendar-check"></i> Visit Scheduled</h3>
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin: 16px 0;">
              <h6 style="margin: 0 0 8px; color: var(--accent);">Appointment Details</h6>
              <p style="margin: 4px 0; font-size: 14px;"><strong>Date:</strong> ${data.schedule.date}</p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>Time:</strong> ${data.schedule.time}</p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>Type:</strong> ${data.schedule.type.replace('_', ' ')}</p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>Status:</strong> ${data.schedule.status}</p>
              <p style="margin: 4px 0; font-size: 14px;"><strong>Schedule ID:</strong> ${data.schedule.id}</p>
            </div>
            <p style="font-size: 13px; color: var(--text-secondary);">
              📱 Reminder will be sent 1 hour before<br>
              📧 Confirmation saved to system
            </p>
            <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">Close</button>
          `;
          document.body.appendChild(scheduleModal);
          
          setTimeout(() => {
            if (scheduleModal.parentNode) {
              scheduleModal.remove();
            }
          }, 6000);
        })
        .catch(error => {
          console.error('Schedule error:', error);
          showNotification('⚠️ Failed to schedule visit. Please try again.', 'error');
        });
      }

      function shareResults() {
        if (analysisHistory.length === 0) {
          alert('No results to share');
          return;
        }
        
        const latest = analysisHistory[0];
        const shareText = `Kgosi BioDrone Detection:\n\nDisease: ${latest.disease}\nConfidence: ${latest.confidence}%\nTime: ${latest.timestampStr}\nSeverity: ${latest.severity.toUpperCase()}\n\nGenerated by Kgosi BioDrone v2.1.0`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Poultry Health Detection',
            text: shareText
          });
        } else {
          navigator.clipboard.writeText(shareText).then(() => {
            alert('Results copied to clipboard');
          });
        }
      }

      function printReport() {
        if (analysisHistory.length === 0) {
          alert('No data to print');
          return;
        }
        
        const printWindow = window.open('', '_blank');
        const stats = generateHealthStats();
        
        printWindow.document.write(`
          <html>
            <head>
              <title>Kgosi BioDrone Report</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .header { border-bottom: 2px solid #ccc; padding-bottom: 20px; margin-bottom: 30px; }
                .stats { display: flex; gap: 20px; margin: 20px 0; }
                .stat-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                .history-item { border-bottom: 1px solid #eee; padding: 12px 0; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>Kgosi BioDrone Health Report</h1>
                <p>Generated: ${new Date().toLocaleString()}</p>
              </div>
              <div class="stats">
                <div class="stat-card">
                  <h3>${stats.total}</h3>
                  <p>Total Analyses</p>
                </div>
                <div class="stat-card">
                  <h3>${stats.healthy}</h3>
                  <p>Healthy</p>
                </div>
                <div class="stat-card">
                  <h3>${stats.warnings}</h3>
                  <p>Warnings</p>
                </div>
                <div class="stat-card">
                  <h3>${stats.critical}</h3>
                  <p>Critical</p>
                </div>
              </div>
              <h2>Recent Detections</h2>
              ${analysisHistory.slice(0, 20).map(item => `
                <div class="history-item">
                  <h4>${item.disease} (${item.confidence}%)</h4>
                  <p><strong>Time:</strong> ${item.timestampStr}</p>
                  <p><strong>Severity:</strong> ${item.severity.toUpperCase()}</p>
                  <p>${item.description}</p>
                </div>
              `).join('')}
            </body>
          </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
      }

      // Settings Modal Functions
      function showSettingsModal() {
        document.getElementById('settingsModal').classList.add('show');
      }

      function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('show');
      }

      function showSettingsSection(section) {
        // Hide all sections
        document.querySelectorAll('.settings-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById(section + '-section').style.display = 'block';
        
        // Update active nav item
        document.querySelectorAll('.settings-nav-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelector(`[data-section="${section}"]`).classList.add('active');
        
        // Update title
        const titles = {
          general: 'General',
          profile: 'User Profile',
          wifi: 'Wi-Fi Settings',
          drone: 'Drone Settings',
          notifications: 'Notifications',
          data: 'Data & Storage',
          security: 'Security',
          about: 'About'
        };
        document.getElementById('settingsTitle').textContent = titles[section];
      }

      // Camera Error Functions
      function showCameraError() {
        document.getElementById('errorTime').textContent = new Date().toLocaleString();
        document.getElementById('cameraErrorModal').classList.add('show');
      }

      function closeCameraError() {
        document.getElementById('cameraErrorModal').classList.remove('show');
      }

      function retryCamera() {
        closeCameraError();
        setTimeout(() => {
          showCameraError(); // Simulate retry failure
        }, 2000);
      }

      // Connection Test with Backend
      function testConnection() {
        fetch('/system/health')
        .then(response => response.json())
        .then(data => {
          displayConnectionTest(data);
        })
        .catch(error => {
          console.error('System health error:', error);
          // Fallback to simulated data
          const fallbackData = {
            status: 'healthy',
            model_loaded: true,
            yolo_available: true,
            uptime: '99.8%',
            avg_latency: '38ms',
            components: {
              drone: { status: 'online', latency: '12ms' },
              camera: { status: 'online', latency: '8ms' },
              wifi: { status: 'strong', signal: '85%' },
              ai_model: { status: 'ready', latency: '156ms' },
              gps: { status: 'fixed', satellites: 12 },
              battery: { status: '78%', health: 'good' }
            }
          };
          displayConnectionTest(fallbackData);
        });
      }
      
      function displayConnectionTest(data) {
        const tests = [
          { name: 'Drone Connection', status: data.components.drone.status, latency: data.components.drone.latency, icon: 'broadcast', health: 'good' },
          { name: 'Camera Module', status: data.components.camera.status, latency: data.components.camera.latency, icon: 'camera', health: 'good' },
          { name: 'Wi-Fi Signal', status: `${data.components.wifi.status} (${data.components.wifi.signal})`, latency: '4ms', icon: 'wifi', health: 'good' },
          { name: 'AI Model', status: data.components.ai_model.status, latency: data.components.ai_model.latency, icon: 'cpu', health: 'good' },
          { name: 'GPS Module', status: `${data.components.gps.status} (${data.components.gps.satellites} satellites)`, latency: '2ms', icon: 'geo-alt', health: 'good' },
          { name: 'Battery Level', status: data.components.battery.status, latency: '—', icon: 'battery-three-quarters', health: data.components.battery.health }
        ];
        const content = `
          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--success);">
            <h6 style="color: var(--success); margin-bottom: 8px;"><i class="bi bi-check-circle"></i> System Status</h6>
            <p style="margin: 0;">${data.status === 'healthy' ? 'All systems operational' : 'System issues detected'} • Last updated: ${new Date(data.timestamp).toLocaleTimeString()}</p>
          </div>
          ${tests.map(test => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <i class="bi bi-${test.icon}" style="font-size: 18px; color: var(--accent);"></i>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">${test.name}</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${test.status}</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #dcfce7; color: #166534; margin-bottom: 4px;">ONLINE</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${test.latency}</div>
              </div>
            </div>
          `).join('')}
          <div class="care-grid" style="margin-top: 16px;">
            <div class="care-card">
              <h6><i class="bi bi-speedometer2"></i> Avg Latency</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--success);">${data.avg_latency}</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-shield-check"></i> Uptime</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--accent);">${data.uptime}</p>
            </div>
          </div>
        `;
        
        showCustomModal('📶 Connection Test', content);
      }

      // Weather Integration (simulated)
      function getWeatherConditions() {
        const conditions = [
          'Clear skies, 22°C',
          'Partly cloudy, 18°C', 
          'Light rain, 16°C',
          'Sunny, 25°C',
          'Overcast, 20°C'
        ];
        return conditions[Math.floor(Math.random() * conditions.length)];
      }

      // Environmental Monitoring with Backend
      function showEnvironmentalData() {
        fetch('/environmental')
        .then(response => response.json())
        .then(data => {
          displayEnvironmentalModal(data);
        })
        .catch(error => {
          console.error('Environmental data error:', error);
          // Fallback to simulated data
          const fallbackData = {
            temperature: (Math.random() * 15 + 15).toFixed(1),
            humidity: (Math.random() * 30 + 50).toFixed(1),
            air_quality: ['Good', 'Fair', 'Poor'][Math.floor(Math.random() * 3)],
            wind_speed: (Math.random() * 10 + 2).toFixed(1),
            weather: getWeatherConditions()
          };
          displayEnvironmentalModal(fallbackData);
        });
      }
      
      function displayEnvironmentalModal(data) {
        const content = `
          <div class="care-grid" style="margin-bottom: 20px;">
            <div class="care-card">
              <h6><i class="bi bi-thermometer-half"></i> Temperature</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--accent);">${data.temperature}°C</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-droplet"></i> Humidity</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--success);">${data.humidity}%</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-wind"></i> Wind Speed</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--warning);">${data.wind_speed} km/h</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-cloud"></i> Air Quality</h6>
              <p style="font-size: 24px; font-weight: 700; color: ${data.air_quality === 'Good' ? 'var(--success)' : data.air_quality === 'Fair' ? 'var(--warning)' : 'var(--danger)'}">${data.air_quality}</p>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">
            <h6 style="color: var(--success); margin-bottom: 8px;"><i class="bi bi-check-circle"></i> Environmental Status</h6>
            <p style="margin: 0;">Last Updated: ${new Date(data.last_update).toLocaleString()}<br>Conditions: Optimal for poultry<br>Recommended Action: Continue monitoring</p>
          </div>
        `;
        
        showCustomModal('🌡️ Environmental Data', content);
      }

      // Advanced Features with Backend Integration
      function performHealthTrend() {
        fetch('/health/trends')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showErrorModal('Insufficient Data', data.error);
            return;
          }
          displayHealthTrends(data);
        })
        .catch(error => {
          console.error('Health trends error:', error);
          // Fallback to local analysis
          if (analysisHistory.length < 3) {
            showErrorModal('Insufficient Data', 'Need at least 3 analyses for trend analysis. Continue monitoring to build trend data.');
            return;
          }
          
          const recentHealthy = analysisHistory.slice(0, 10).filter(h => h.severity === 'healthy').length;
          const recentWarning = analysisHistory.slice(0, 10).filter(h => h.severity === 'warning').length;
          const recentCritical = analysisHistory.slice(0, 10).filter(h => h.severity === 'critical').length;
          const trend = recentHealthy >= 6 ? 'Improving' : recentHealthy >= 3 ? 'Stable' : 'Concerning';
          
          const chartData = analysisHistory.slice(0, 7).reverse().map((item, index) => ({
            day: `Day ${index + 1}`,
            healthy: item.severity === 'healthy' ? 1 : 0,
            warning: item.severity === 'warning' ? 1 : 0,
            critical: item.severity === 'critical' ? 1 : 0
          }));
          
          const fallbackData = {
            stats: { total: analysisHistory.length, healthy: recentHealthy, warnings: recentWarning, critical: recentCritical },
            trend_data: chartData,
            trend: trend,
            recommendation: trend === 'Concerning' ? 'Increase monitoring frequency and consider veterinary consultation' : 'Continue current practices and maintain regular monitoring'
          };
          
          displayHealthTrends(fallbackData);
        });
      }
      
      function displayHealthTrends(data) {
        const chartData = data.trend_data;
        const content = `
          <div class="care-grid" style="margin-bottom: 20px;">
            <div class="care-card">
              <h6><i class="bi bi-heart-pulse"></i> Healthy</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--success);">${data.stats.healthy}</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-exclamation-triangle"></i> Warnings</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--warning);">${data.stats.warnings}</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-x-circle"></i> Critical</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--danger);">${data.stats.critical}</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-graph-up"></i> Trend</h6>
              <p style="font-size: 24px; font-weight: 700; color: ${data.trend === 'Improving' ? 'var(--success)' : data.trend === 'Stable' ? 'var(--warning)' : 'var(--danger)'}">${data.trend}</p>
            </div>
          </div>
          <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h6 style="margin-bottom: 12px;">7-Day Health Trend</h6>
            <div style="display: flex; align-items: end; gap: 8px; height: 120px;">
              ${chartData.map((data, i) => `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="display: flex; flex-direction: column; width: 100%; height: 100px; justify-content: end;">
                    ${data.critical ? '<div style="background: var(--danger); height: 30px; width: 100%; margin-bottom: 2px; border-radius: 2px;"></div>' : ''}
                    ${data.warning ? '<div style="background: var(--warning); height: 30px; width: 100%; margin-bottom: 2px; border-radius: 2px;"></div>' : ''}
                    ${data.healthy ? '<div style="background: var(--success); height: 30px; width: 100%; margin-bottom: 2px; border-radius: 2px;"></div>' : ''}
                    ${!data.healthy && !data.warning && !data.critical ? '<div style="background: #f3f4f6; height: 10px; width: 100%; border-radius: 2px;"></div>' : ''}
                  </div>
                  <small style="margin-top: 8px; font-size: 10px;">${data.day}</small>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 12px;">
              <div><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px; margin-right: 4px;"></span>Healthy</div>
              <div><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 2px; margin-right: 4px;"></span>Warning</div>
              <div><span style="display: inline-block; width: 12px; height: 12px; background: var(--danger); border-radius: 2px; margin-right: 4px;"></span>Critical</div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid ${data.trend === 'Improving' ? 'var(--success)' : data.trend === 'Stable' ? 'var(--warning)' : 'var(--danger)'};">
            <h6 style="color: ${data.trend === 'Improving' ? 'var(--success)' : data.trend === 'Stable' ? 'var(--warning)' : 'var(--danger)'}; margin-bottom: 8px;"><i class="bi bi-lightbulb"></i> Recommendation</h6>
            <p style="margin: 0;">${data.recommendation}</p>
          </div>
        `;
        
        showCustomModal('📈 Health Trends', content);
      }

      function scheduleAutomaticScan() {
        fetch('/schedule')
        .then(response => response.json())
        .then(data => {
          displayScheduleModal(data.schedules);
        })
        .catch(error => {
          console.error('Schedule error:', error);
          // Fallback to demo schedules
          const schedules = [
            { time: '08:00', status: 'completed', result: 'Healthy' },
            { time: '10:00', status: 'completed', result: 'Healthy' },
            { time: '12:00', status: 'active', result: 'In Progress' },
            { time: '14:00', status: 'pending', result: 'Scheduled' },
            { time: '16:00', status: 'pending', result: 'Scheduled' }
          ];
          displayScheduleModal(schedules);
        });
      }
      
      function displayScheduleModal(schedules) {
        
        const content = `
          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent);">
            <h6 style="color: var(--accent); margin-bottom: 8px;"><i class="bi bi-info-circle"></i> Schedule Configuration</h6>
            <p style="margin: 0; font-size: 14px;">Automatic scans every 2 hours during daylight (08:00 - 16:00)<br>Emergency alerts enabled • Reports sent to registered email</p>
          </div>
          <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h6 style="margin-bottom: 12px;">Today's Schedule</h6>
            ${schedules.map(schedule => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-weight: 600;">${schedule.time}</span>
                  <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: ${
                    schedule.status === 'completed' ? '#dcfce7; color: #166534' :
                    schedule.status === 'active' ? '#fef3c7; color: #92400e' :
                    '#f3f4f6; color: #6b7280'
                  };">${schedule.status.toUpperCase()}</span>
                </div>
                <span style="font-size: 13px; color: var(--text-secondary);">${schedule.result}</span>
              </div>
            `).join('')}
          </div>
          <div class="care-grid">
            <div class="care-card">
              <h6><i class="bi bi-check-circle"></i> Completed</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--success);">2</p>
            </div>
            <div class="care-card">
              <h6><i class="bi bi-clock"></i> Pending</h6>
              <p style="font-size: 24px; font-weight: 700; color: var(--warning);">2</p>
            </div>
          </div>
        `;
        
        const actions = `
          <button class="btn btn-primary" onclick="closeCustomModal()">OK</button>
          <button class="btn btn-secondary" onclick="closeCustomModal(); showSettingsModal();">Settings</button>
        `;
        
        showCustomModal('📅 Automatic Scan Schedule', content, actions);
      }

      function generateHealthInsights() {
        if (analysisHistory.length === 0) {
          alert('No data available for insights');
          return;
        }
        
        const diseaseTypes = {};
        analysisHistory.forEach(item => {
          diseaseTypes[item.disease] = (diseaseTypes[item.disease] || 0) + 1;
        });
        
        const mostCommon = Object.entries(diseaseTypes).sort((a, b) => b[1] - a[1])[0];
        const insights = [
          `Most frequent detection: ${mostCommon[0]} (${mostCommon[1]} times)`,
          `Average confidence: ${(analysisHistory.reduce((sum, item) => sum + item.confidence, 0) / analysisHistory.length).toFixed(1)}%`,
          `Health rate: ${(analysisHistory.filter(h => h.severity === 'healthy').length / analysisHistory.length * 100).toFixed(1)}%`
        ];
        
        alert(`Health Insights:\n\n${insights.join('\n')}\n\nRecommendation: ${mostCommon[1] > 3 ? 'Consider preventive measures for recurring issues' : 'Continue current monitoring practices'}`);
      }

      // Keyboard Shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'Enter':
              e.preventDefault();
              if (!document.getElementById('analyzeBtn').disabled) {
                analyzeImage();
              }
              break;
            case 's':
              e.preventDefault();
              saveSnapshot();
              break;
            case 'c':
              e.preventDefault();
              if (currentInputMode === 'camera') {
                captureImage();
              }
              break;
            case ',':
              e.preventDefault();
              showSettingsModal();
              break;
          }
        }
        
        if (e.key === 'Escape') {
          // Close any open modals
          document.querySelectorAll('.modal.show, .settings-modal.show, .error-modal.show').forEach(modal => {
            modal.classList.remove('show');
          });
          closeAlertModal();
          closeErrorModal();
        }
      });

      // Modal Functions
      function showAlertModal(title, message, actions = null) {
        document.getElementById('alertTitle').innerHTML = `<i class="bi bi-info-circle"></i> ${title}`;
        document.getElementById('alertMessage').textContent = message;
        
        if (actions) {
          document.getElementById('alertActions').innerHTML = actions;
        } else {
          document.getElementById('alertActions').innerHTML = '<button class="btn btn-primary" onclick="closeAlertModal()">OK</button>';
        }
        
        document.getElementById('alertModal').classList.add('show');
      }

      function closeAlertModal() {
        document.getElementById('alertModal').classList.remove('show');
      }

      function showCustomModal(title, content, actions = null) {
        document.getElementById('alertTitle').innerHTML = `${title}`;
        document.getElementById('alertMessage').innerHTML = content;
        
        if (actions) {
          document.getElementById('alertActions').innerHTML = actions;
        } else {
          document.getElementById('alertActions').innerHTML = '<button class="btn btn-primary" onclick="closeCustomModal()">Close</button>';
        }
        
        document.getElementById('alertModal').classList.add('show');
      }

      function closeCustomModal() {
        document.getElementById('alertModal').classList.remove('show');
      }

      function resetSettings() {
        if (confirm('Reset all settings to default values?')) {
          localStorage.removeItem('kgosi_settings');
          
          // Reset form values
          document.querySelectorAll('[data-setting]').forEach(input => {
            if (input.type === 'checkbox') {
              input.checked = input.id === 'autoAnalyze';
            } else {
              input.value = '';
            }
          });
          
          showNotification('Settings reset to defaults', 'info', 3000);
        }
      }

      function clearAllData() {
        if (confirm('This will permanently delete all analysis history. Continue?')) {
          analysisHistory = [];
          updateHistoryDisplay();
          resetResults();
          showNotification('All data cleared successfully', 'info', 3000);
        }
      }

      let selectedNetwork = '';
      
      function changeNetwork() {
        const networks = [
          { name: 'FarmNet_5G', signal: 'Strong (85%)', security: 'WPA3' },
          { name: 'DroneNet_2.4G', signal: 'Good (72%)', security: 'WPA2' },
          { name: 'Mobile_Hotspot', signal: 'Fair (58%)', security: 'WPA2' },
          { name: 'Backup_WiFi', signal: 'Weak (34%)', security: 'WPA2' }
        ];
        
        document.getElementById('networkList').innerHTML = networks.map(network => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="connectToNetwork('${network.name}')">
            <div style="display: flex; align-items: center; gap: 12px;">
              <i class="bi bi-wifi" style="font-size: 18px; color: var(--accent);"></i>
              <div>
                <div style="font-weight: 600; font-size: 14px;">${network.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${network.security}</div>
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: var(--text-secondary);">${network.signal}</div>
            </div>
          </div>
        `).join('');
        
        document.getElementById('networkModal').classList.add('show');
      }
      
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
      }

      function connectToNetwork(networkName) {
        selectedNetwork = networkName;
        closeModal('networkModal');
        
        // Show credentials modal
        document.getElementById('selectedNetworkName').textContent = networkName;
        document.getElementById('wifiPassword').value = '';
        document.getElementById('wifiCredentialsModal').classList.add('show');
      }
      
      function connectWithCredentials() {
        const password = document.getElementById('wifiPassword').value;
        
        if (!password.trim()) {
          showNotification('Please enter the WiFi password', 'warning');
          return;
        }
        
        closeModal('wifiCredentialsModal');
        
        // Show connection progress
        showCustomModal('Connecting to Network', `
          <div style="text-align: center; padding: 20px;">
            <div class="spinner" style="margin: 0 auto 16px;"></div>
            <p>Connecting to <strong>${selectedNetwork}</strong>...</p>
            <div style="background: var(--bg-secondary); border-radius: 4px; padding: 8px; margin-top: 12px;">
              <div style="font-size: 12px; color: var(--text-secondary);">Status: Authenticating...</div>
            </div>
          </div>
        `);
        
        // Simulate connection process
        setTimeout(() => {
          closeCustomModal();
          
          // Update current network in settings
          const networkLabel = document.querySelector('#wifi-section .setting-label small');
          if (networkLabel) {
            networkLabel.textContent = `Connected to: ${selectedNetwork}`;
          }
          
          showNotification(`Successfully connected to ${selectedNetwork}`, 'success');
        }, 3000);
      }

      function refreshNetworks() {
        showNotification('Scanning for networks...', 'info', 1500);
        setTimeout(() => {
          changeNetwork(); // Reload the network selection modal
        }, 1500);
      }

      function showErrorModal(title, message) {
        document.querySelector('#errorModal h3').innerHTML = `<i class="bi bi-exclamation-triangle text-warning"></i> ${title}`;
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').classList.add('show');
      }

      function closeErrorModal() {
        document.getElementById('errorModal').classList.remove('show');
      }

      // Close modals on outside click (except progress modal)
      window.addEventListener('click', (e) => {
        if ((e.target.classList.contains('modal') || e.target.id === 'settingsModal') && 
            e.target.id !== 'progressModal' && e.target.id !== 'alertModal' && e.target.id !== 'errorModal' && 
            e.target.id !== 'wifiCredentialsModal' && e.target.id !== 'networkModal') {
          e.target.classList.remove('show');
        }
      });

      // Prevent closing progress modal during analysis
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('progressModal').classList.contains('show')) {
          e.preventDefault();
          return false;
        }
        
        // Allow Enter key to connect in WiFi credentials modal
        if (e.key === 'Enter' && document.getElementById('wifiCredentialsModal').classList.contains('show')) {
          connectWithCredentials();
        }
      });

      // Performance Monitoring
      let performanceStats = {
        analysisCount: 0,
        totalAnalysisTime: 0,
        averageConfidence: 0
      };

      function updatePerformanceStats(analysisTime, confidence) {
        performanceStats.analysisCount++;
        performanceStats.totalAnalysisTime += analysisTime;
        performanceStats.averageConfidence = analysisHistory.reduce((sum, item) => sum + item.confidence, 0) / analysisHistory.length;
      }

      // Initialize tooltips for better UX
      function initializeTooltips() {
        document.querySelectorAll('[title]').forEach(element => {
          element.addEventListener('mouseenter', function() {
            const tooltip = document.createElement('div');
            tooltip.textContent = this.getAttribute('title');
            tooltip.style.cssText = `
              position: absolute;
              background: rgba(0,0,0,0.8);
              color: white;
              padding: 4px 8px;
              border-radius: 4px;
              font-size: 12px;
              z-index: 1000;
              pointer-events: none;
            `;
            document.body.appendChild(tooltip);
            
            this.addEventListener('mouseleave', () => tooltip.remove(), { once: true });
          });
        });
      }

      // Auto-save functionality
      function autoSaveHistory() {
        try {
          // In a real app, this would save to a database
          console.log('Auto-saving history...', analysisHistory.length, 'items');
        } catch (error) {
          console.warn('Auto-save failed:', error);
        }
      }

      // Periodic auto-save
      setInterval(autoSaveHistory, 60000); // Every minute

      // Status monitoring
      function updateSystemStatus() {
        const statusDots = document.querySelectorAll('.status-dot');
        if (statusDots.length >= 2) {
          const droneStatus = statusDots[0];
          const aiStatus = statusDots[1];
          
          // Simulate occasional connection issues
          if (Math.random() < 0.1) {
            droneStatus.className = 'status-dot status-warning';
            droneStatus.title = 'Drone Warning';
          } else {
            droneStatus.className = 'status-dot status-online';
            droneStatus.title = 'Drone Online';
          }
        }
      }

      // Update status every 30 seconds
      setInterval(updateSystemStatus, 30000);

      // Enhanced Settings Persistence with Backend
      function saveSettings() {
        const settings = {};
        
        // Collect all form inputs with data-setting attribute
        document.querySelectorAll('[data-setting]').forEach(input => {
          const key = input.getAttribute('data-setting');
          if (input.type === 'checkbox') {
            settings[key] = input.checked;
          } else {
            settings[key] = input.value;
          }
        });
        
        // Save to backend
        fetch('/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ settings })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showErrorModal('Save Failed', data.error);
          } else {
            // Apply settings immediately
            applySettings(settings);
            showNotification('Settings saved successfully', 'success', 3000);
          }
        })
        .catch(error => {
          console.error('Settings save error:', error);
          // Fallback to local storage
          localStorage.setItem('kgosi_settings', JSON.stringify(settings));
          applySettings(settings);
          showNotification('Settings saved locally', 'warning', 3000);
        });
      }

      function applySettings(settings) {
        // Apply theme
        if (settings.theme) {
          document.body.className = settings.theme === 'dark' ? 'dark-theme' : '';
        }
      }

      function loadSettingsFromStorage() {
        // This function is now replaced by loadUserSettings() which loads from backend
        // Keep as fallback for offline mode
        try {
          const settings = JSON.parse(localStorage.getItem('kgosi_settings') || '{}');
          
          Object.entries(settings).forEach(([key, value]) => {
            const input = document.querySelector(`[data-setting="${key}"]`);
            if (input) {
              if (input.type === 'checkbox') {
                input.checked = value;
              } else {
                input.value = value;
              }
            }
          });
          
          // Apply loaded settings
          applySettings(settings);
        } catch (error) {
          console.warn('Failed to load settings:', error);
        }
      }

      // Auto-save settings when changed
      function setupSettingsAutoSave() {
        document.querySelectorAll('#settingsModal input, #settingsModal select').forEach(input => {
          input.addEventListener('change', saveSettingsToStorage);
        });
      }

      // Authentication functions with backend integration
      function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
      }

      function showRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerTab').classList.add('active');
      }

      function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
          showErrorModal('Missing Information', 'Please enter both username and password');
          return;
        }

        // Show loading state
        const loginBtn = document.querySelector('#loginForm .auth-btn');
        loginBtn.classList.add('loading');
        loginBtn.disabled = true;

        fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showErrorModal('Login Failed', data.error);
          } else {
            document.getElementById('authModal').style.display = 'none';
            updateUserInterface(data);
            showNotification(`Welcome back, ${data.username}!`, 'success');
            loadUserSettings();
          }
        })
        .catch(error => {
          console.error('Login error:', error);
          showErrorModal('Connection Error', 'Unable to connect to server. Please try again.');
        })
        .finally(() => {
          loginBtn.classList.remove('loading');
          loginBtn.disabled = false;
        });
      }

      function register() {
        const username = document.getElementById('regUsername').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        
        if (!username || !email || !password || !confirmPassword) {
          showErrorModal('Missing Information', 'Please fill in all fields');
          return;
        }
        
        if (password !== confirmPassword) {
          showErrorModal('Password Mismatch', 'Passwords do not match');
          return;
        }
        
        if (password.length < 6) {
          showErrorModal('Weak Password', 'Password must be at least 6 characters');
          return;
        }

        // Show loading state
        const registerBtn = document.querySelector('#registerForm .auth-btn');
        registerBtn.classList.add('loading');
        registerBtn.disabled = true;

        fetch('/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email, password })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showErrorModal('Registration Failed', data.error);
          } else {
            document.getElementById('authModal').style.display = 'none';
            updateUserInterface(data);
            showNotification(`Account created successfully! Welcome, ${data.username}!`, 'success');
          }
        })
        .catch(error => {
          console.error('Registration error:', error);
          showErrorModal('Connection Error', 'Unable to connect to server. Please try again.');
        })
        .finally(() => {
          registerBtn.classList.remove('loading');
          registerBtn.disabled = false;
        });
      }

      function logout() {
        fetch('/auth/logout', {
          method: 'POST'
        })
        .then(() => {
          document.getElementById('authModal').style.display = 'flex';
          document.getElementById('userWelcome').textContent = '';
          showLogin();
          showNotification('Logged out successfully', 'info');
        })
        .catch(error => {
          console.error('Logout error:', error);
          // Still log out locally even if server request fails
          document.getElementById('authModal').style.display = 'flex';
          document.getElementById('userWelcome').textContent = '';
          showLogin();
        });
      }

      function updateUserInterface(userData) {
        if (userData && userData.username) {
          document.getElementById('userWelcome').textContent = `Welcome, ${userData.username}`;
        }
      }

      function checkAuth() {
        fetch('/auth/status')
        .then(response => response.json())
        .then(data => {
          if (data.authenticated) {
            document.getElementById('authModal').style.display = 'none';
            updateUserInterface(data);
            loadUserSettings();
          } else {
            document.getElementById('authModal').style.display = 'flex';
            showLogin();
          }
        })
        .catch(error => {
          console.error('Auth check error:', error);
          document.getElementById('authModal').style.display = 'flex';
          showLogin();
        });
      }
      
      function loadUserSettings() {
        fetch('/settings')
        .then(response => response.json())
        .then(data => {
          if (data.settings) {
            applySettings(data.settings);
            populateSettingsForm(data.settings);
          }
        })
        .catch(error => {
          console.warn('Failed to load user settings:', error);
        });
      }
      
      function populateSettingsForm(settings) {
        Object.entries(settings).forEach(([key, value]) => {
          const input = document.querySelector(`[data-setting="${key}"]`);
          if (input) {
            if (input.type === 'checkbox') {
              input.checked = value;
            } else {
              input.value = value;
            }
          }
        });
      }

      // Initialize app
      window.addEventListener('load', function() {
        checkAuth();
        initializeTooltips();
        updateSystemStatus();
        loadSettingsFromStorage();
        setupSettingsAutoSave();
        loadHistoryFromBackend();
        
        // Show welcome message for first-time users
        if (analysisHistory.length === 0) {
          setTimeout(() => {
            const welcome = document.createElement('div');
            welcome.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: var(--accent);
              color: white;
              padding: 16px 20px;
              border-radius: 8px;
              box-shadow: var(--shadow-lg);
              max-width: 300px;
              z-index: 1000;
              animation: slideIn 0.3s ease;
            `;
            welcome.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <h6 style="margin: 0 0 8px; font-weight: 600;">Welcome to Kgosi BioDrone!</h6>
                  <p style="margin: 0; font-size: 13px; opacity: 0.9;">Start the camera to begin monitoring your flock's health.</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 16px; cursor: pointer;">×</button>
              </div>
            `;
            document.body.appendChild(welcome);
            
            setTimeout(() => welcome.remove(), 8000);
          }, 1000);
        }
      });

      // Enhanced notification system
      function showNotification(message, type = 'info', duration = 4000) {
        const notification = document.createElement('div');
        const colors = {
          info: 'var(--accent)',
          success: 'var(--success)',
          warning: 'var(--warning)',
          error: 'var(--danger)'
        };
        
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${colors[type]};
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: var(--shadow-lg);
          max-width: 300px;
          z-index: 1100;
          animation: slideIn 0.3s ease;
          font-size: 14px;
        `;
        
        notification.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 12px;">×</button>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        if (duration > 0) {
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, duration);
        }
        
        return notification;
      }

      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
        
        .pulse {
          animation: pulse 2s infinite;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>